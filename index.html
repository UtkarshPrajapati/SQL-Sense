<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataFlow</title>
    <link rel="icon" href="/static/DataFlow.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
    <style>
        :root {
            --md-primary-color: #3f51b5; /* Indigo */
            --md-primary-color-dark: #303f9f;
            --md-accent-color: #448aff; /* Blue A200 */
            --md-text-primary-on-background: rgba(0,0,0,0.87);
            --md-text-secondary-on-background: rgba(0,0,0,0.60);
            --md-surface-color: #ffffff;
            --md-background-color: #f5f5f5; /* Lighter gray for body */
            --md-error-color: #f44336;
            --md-border-color: #e0e0e0; /* Lighter border */
            --md-elevation-1: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.20);
            --md-elevation-2: 0 4px 5px 0 rgba(0,0,0,0.14), 0 1px 10px 0 rgba(0,0,0,0.12), 0 2px 4px -1px rgba(0,0,0,0.20);
            --md-elevation-3: 0 6px 10px 0 rgba(0,0,0,0.14), 0 1px 18px 0 rgba(0,0,0,0.12), 0 3px 5px -1px rgba(0,0,0,0.20);
        }

        body {
            font-family: 'Roboto', sans-serif; /* Material Design uses Roboto */
            background-color: var(--md-background-color);
            color: var(--md-text-primary-on-background);
        }
        /* Import Roboto font (add to <head> if not already - this is a CSS import) */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');


        /* Custom scrollbar for chat history - slightly more subtle */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-track {
            background: #eeeeee; /* Lighter track */
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background: #bdbdbd; /* Grey for thumb */
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb:hover {
            background: #9e9e9e; /* Darker grey on hover */
        }
        
        pre {
            white-space: pre-wrap;      
            word-wrap: break-word;      
            background-color: #f0f0f0; /* Lighter background for code blocks */
            border-radius: 4px;
            padding: 0.75rem 1rem;
            box-shadow: var(--md-elevation-1);
            border: 1px solid var(--md-border-color);
        }
        code.language-sql {
            font-family: 'Roboto Mono', monospace; /* Consistent monospaced font */
        }


        /* Style for generated tables - Material inspired */
        .results-table {
            max-height: 450px; /* Slightly increased height */
            overflow-y: auto;
            border: 1px solid var(--md-border-color);
            border-radius: 8px; /* More rounded */
            margin-top: 1rem; 
            margin-bottom: 1.5rem; 
            box-shadow: var(--md-elevation-1);
        }
        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            border: none; /* Remove internal borders for cleaner look */
            border-bottom: 1px solid var(--md-border-color); /* Horizontal lines only */
            padding: 0.75rem 1rem; /* Increased padding */
            text-align: left;
            font-size: 0.9rem; 
        }
        .results-table th {
            background-color: #fafafa; /* Very light grey for header */
            font-weight: 500; /* Medium font weight */
            color: var(--md-text-secondary-on-background);
            position: sticky; 
            top: 0;
            z-index: 10;
            border-bottom-width: 2px; /* Thicker bottom border for header */
        }
        .results-table tbody tr:nth-child(even) {
            background-color: transparent; /* Remove alternating row color for cleaner look */
        }
        .results-table tbody tr:hover {
            background-color: rgba(0,0,0,0.04); /* Subtle hover effect */
        }

        /* Config popup styles - Material Card */
        #config-popup {
            position: fixed; /* Use fixed if it should overlay scroll */
            top: 70px;
            right: 20px;
            z-index: 100; /* Ensure it's above other elements */
            width: 320px; /* Slightly wider */
            background-color: var(--md-surface-color);
            border-radius: 8px; /* More pronounced rounding */
            box-shadow: var(--md-elevation-3); /* Stronger shadow for popup */
            opacity: 0;
            transform: translateY(-20px) scale(0.98); /* Adjusted for smoother entry */
            transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            visibility: hidden;
            transform-origin: top right;
        }
        #config-popup.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
            pointer-events: auto;
        }
        #config-popup label {
            color: var(--md-text-secondary-on-background);
            font-size: 0.8rem;
        }
        #config-popup input[type="text"], 
        #config-popup input[type="password"] {
            border: none;
            border-bottom: 1px solid var(--md-border-color);
            border-radius: 0; /* Flat bottom border for Material inputs */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            transition: border-color 0.2s ease-in-out;
        }
        #config-popup input[type="text"]:focus, 
        #config-popup input[type="password"]:focus {
            border-bottom: 2px solid var(--md-primary-color);
            box-shadow: none; /* Remove Tailwind focus shadow */
        }
        
        /* Styles for floating label inputs in config */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem; /* ~24px, provides more space */
        }
        .input-group .icon {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            color: var(--md-text-secondary-on-background);
            pointer-events: none;
            transition: color 0.2s ease;
        }
        /* When focused, also make the icon colored */
        .input-group input:focus ~ .icon {
            color: var(--md-primary-color);
        }
        .input-group input {
            width: 100%;
            padding: 10px 40px 10px 40px; /* Top, Right, Bottom, Left */
            background-color: transparent;
            border: none;
            border-bottom: 1px solid var(--md-border-color);
            border-radius: 0;
            font-size: 0.9rem;
            color: var(--md-text-primary-on-background);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-group input:focus {
            outline: none;
            border-bottom-width: 2px;
            border-bottom-color: var(--md-primary-color);
            box-shadow: none; /* Override Tailwind focus shadow */
        }
        .input-group .floating-label {
            position: absolute;
            top: 10px;
            left: 40px; /* Position next to icon */
            font-size: 0.9rem;
            color: var(--md-text-secondary-on-background);
            pointer-events: none;
            transition: all 0.2s ease-in-out;
            background-color: var(--md-surface-color); /* To cover the line when floated */
        }
        /* State when input has content or is focused */
        .input-group input:not(:placeholder-shown) + .floating-label,
        .input-group input:focus + .floating-label {
            top: -8px;
            left: 10px;
            font-size: 0.75rem;
            color: var(--md-primary-color);
            padding: 0 4px;
        }
        .input-group .toggle-password {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--md-text-secondary-on-background);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .input-group .toggle-password:hover {
            background-color: rgba(0,0,0,0.08);
            color: var(--md-text-primary-on-background);
        }

        /* Settings icon rotation animation - unchanged */
        @keyframes rotate-cw {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(180deg); }
        }
        @keyframes rotate-ccw {
            0% { transform: rotate(180deg); }
            100% { transform: rotate(0deg); }
        }
        .settings-icon-rotate-cw { animation: rotate-cw 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .settings-icon-rotate-ccw { animation: rotate-ccw 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* Toast notification styles - Materialized */
        #toast-container {
            position: fixed;
            bottom: 1rem; /* Position at bottom */
            right: 1rem;   /* Usually bottom-left or bottom-center for toasts */
            left: auto; /* to ensure right positioning */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Increased gap */
            max-width: 350px; /* Slightly wider toasts */
        }
        .toast {
            padding: 0.75rem 1.25rem; /* Adjust padding */
            border-radius: 4px; /* Standard Material rounding */
            box-shadow: var(--md-elevation-2);
            display: flex;
            align-items: center; /* Center align items vertically */
            justify-content: space-between;
            margin-bottom: 0; /* Gap is handled by container */
            animation: toast-in-material 0.3s cubic-bezier(0, 0, 0.2, 1) forwards;
            max-width: 100%;
            background-color: #323232; /* Dark background for Material toasts */
            color: #ffffff; /* White text */
            border-left: none; /* Remove side border */
        }
        .toast-success { background-color: #4caf50; color: white; }
        .toast-warning { background-color: #ff9800; color: white; }
        .toast-error { background-color: var(--md-error-color); color: white; }
        .toast-info { background-color: var(--md-accent-color); color: white; }

        .toast-content {
            flex: 1;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-line;
            font-size: 0.9rem;
        }
        .toast-close {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.25rem; /* Larger close icon */
            margin-left: 1rem;
            padding: 0;
            color: rgba(255,255,255,0.7);
            opacity: 1; /* Opacity managed by color */
            transition: color 0.2s ease-in-out;
        }
        .toast-close:hover { color: rgba(255,255,255,1); }

        @keyframes toast-in-material { /* Adjusted animation for bottom entry */
            0% { transform: translateY(100%) scale(0.9); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes toast-out-material {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(50%) scale(0.9); opacity: 0; }
        }
        .toast-remove { animation: toast-out-material 0.25s cubic-bezier(0.4, 0, 1, 1) forwards; }

        /* Autocomplete popup for slash commands - Materialized */
        #slash-command-popup {
            left: 1rem; 
            width: auto; 
            background-color: var(--md-surface-color); /* Surface color */
            color: var(--md-text-primary-on-background); /* Standard text color */
            border-radius: 4px; 
            overflow: hidden; 
            box-shadow: var(--md-elevation-2); /* Material shadow */
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
        }
        #slash-command-popup div {
            padding: 0.75rem 1rem; /* Consistent padding */
            cursor: pointer;
            text-align: left; /* Align text left for list items */
            font-size: 0.9rem;
            transition: background-color 0.15s ease-out;
        }
        #slash-command-popup div:hover {
            background-color: rgba(0,0,0,0.08); /* Subtle hover for light theme */
        }

        /* Style for the /run command tag in input - Material Chip like */
        #run-command-tag {
            flex-shrink: 0; 
            border-radius: 16px; /* Pill shape for chips */
            position: relative; 
            overflow: visible; /* Allow button to be slightly outside if needed */
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.5rem; 
            margin-right: 0.5rem; 
            padding: 0.25rem 0.75rem; /* Adjust padding */
            font-size: 0.8rem;
            box-shadow: var(--md-elevation-1);
        }
        /* Removed ::before and adjusted remove button directly */
        #remove-run-tag-btn {
            opacity: 0.6; /* Slightly visible by default */
            position: relative; /* Adjusted for inline display */
            transform: none;
            line-height: 1; 
            transition: opacity 0.2s ease-in-out;
            z-index: 10; 
            padding: 0.1rem; /* Smaller padding */
            margin-left: 0.35rem; /* Space from text */
            border-radius: 50%; 
            background-color: transparent;
            color: inherit; /* Inherit color from parent */
        }
         #run-command-tag:hover #remove-run-tag-btn {
            opacity: 1;
        }
        #remove-run-tag-btn svg {
             width: 0.75rem; /* Smaller icon */
             height: 0.75rem;
        }

        /* Additional global styles for Material feel */
        button, input[type="submit"], input[type="button"] {
            transition: box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase; /* Material buttons are often uppercase */
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        button:hover, input[type="submit"]:hover, input[type="button"]:hover {
            box-shadow: var(--md-elevation-1); /* Subtle shadow on hover for primary buttons */
        }
        /* Specific button styles if needed */
        .button-primary {
            background-color: var(--md-primary-color);
            color: white;
        }
        .button-primary:hover {
            background-color: var(--md-primary-color-dark);
            box-shadow: var(--md-elevation-2);
        }
        
        /* Chat bubbles */
        #chat-history .p-3.rounded-lg { /* Target existing chat bubbles more specifically */
            box-shadow: var(--md-elevation-1);
            border: 1px solid transparent; /* Prepare for potential border changes */
            margin-bottom: 0.75rem !important; /* Override Tailwind space-y */
        }
        #chat-history .p-3.rounded-lg.ml-auto { /* User messages */
            background-color: var(--md-accent-color); /* Use accent for user */
            color: white;
             border-radius: 16px 16px 4px 16px; /* Slightly different bubble shape */
        }
         #chat-history .p-3.rounded-lg.mr-auto { /* Assistant messages */
            background-color: var(--md-surface-color);
            color: var(--md-text-primary-on-background);
            border: 1px solid var(--md-border-color);
            border-radius: 16px 16px 16px 4px;
        }

        /* Prose adjustments for chat bubbles */
        #chat-history .prose {
             font-size: 0.95rem; /* Slightly larger base font for chat */
        }
         #chat-history .prose p {
             margin-top: 0.5em;
             margin-bottom: 0.5em;
         }
         #chat-history .prose pre { /* Style code blocks within chat messages */
             margin-top: 0.75em;
             margin-bottom: 0.75em;
             background-color: rgba(0,0,0,0.05); /* Different background for nested code */
             color: var(--md-text-primary-on-background); /* Ensure text is dark */
             box-shadow: none;
             border: 1px solid rgba(0,0,0,0.1);
         }
         #chat-history .ml-auto .prose pre { /* User message code blocks */
             background-color: rgba(255,255,255,0.1);
             border-color: rgba(255,255,255,0.2);
         }

        /* Animations for schema icon toggle */
        @keyframes iconAnimateOut {
            from { opacity: 1; transform: scale(1) rotate(0deg); }
            to   { opacity: 0; transform: scale(0.6) rotate(-75deg); }
        }
        @keyframes iconAnimateIn {
            from { opacity: 0; transform: scale(0.6) rotate(75deg); }
            to   { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        /* ADDED: Keyframes for icon/spinner fade transitions */
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to   { opacity: 0; transform: scale(0.8); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to   { opacity: 1; transform: scale(1); }
        }
        .icon-fade-out {
            animation: fadeOut 0.15s ease-out forwards;
        }
        .icon-fade-in {
            animation: fadeIn 0.15s ease-out forwards;
        }

        .schema-icon-animate-out {
            animation: iconAnimateOut 0.1s ease-in-out forwards;
        }
        .schema-icon-animate-in {
            animation: iconAnimateIn 0.1s ease-in-out forwards;
        }

        @keyframes rotate360cw {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }

        #header-db-icon.icon-rotate-onload {
            animation: rotate360cw 0.5s ease-in-out;
        }

        /* --- STYLES of SIDEBAR --- */
        #main-content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden; /* Important for child flex items */
            position: relative; /* ADDED: For absolute positioning of the schema sidebar */
        }

        main#chat-area { /* ADDED ID for clarity, was just main before */
            flex: 1; /* Takes remaining space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Handles its own scrolling */
            position: relative; /* For absolute positioned children like slash command popup */
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* ADDED: Smooth margin adjustment */
        }

        #schema-display {
            width: 320px; /* MODIFIED: Fixed width */
            position: absolute; /* MODIFIED: Position relative to main-content-wrapper */
            right: 0;
            top: 0;
            bottom: 0;
            background-color: var(--md-surface-color);
            border-left: 1px solid var(--md-border-color);
            overflow-y: auto;
            padding: 1rem; /* ADDED: Consistent padding, always applied */

            opacity: 0; /* Initially transparent */
            transform: translateX(100%); /* MODIFIED: Initially off-screen to the right */
            visibility: hidden; /* MODIFIED: Hidden and not interactive initially */
            /* MODIFIED: Transition for transform, opacity, and visibility handling */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        visibility 0s linear 0.3s; /* Delay hiding until after transform */
            z-index: 50; /* ADDED: Ensure it's above chat but below modals/config */
            /* Removed: flex-shrink, height (implicit from top/bottom/absolute), previous transition, position:static, max-height:none */
        }

        #schema-display.open {
            opacity: 1;
            transform: translateX(0%); /* MODIFIED: Slide in */
            visibility: visible;
            /* MODIFIED: Transition for opening, no visibility delay */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Removed: width, padding (now in base style) */
        }
        
        #schema-display-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem; /* Space below header */
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--md-border-color);
        }

        #schema-display-header h3 {
            font-weight: 500; /* Material medium */
            color: var(--md-text-primary-on-background);
            font-size: 1rem;
        }

        
        .schema-item {
            padding: 0.35rem 0.5rem; /* Reduced padding */
            border-radius: 4px;
            margin-bottom: 0.25rem; /* Spacing between items */
            display: flex;
            align-items: center;
            font-size: 0.85rem; /* Slightly smaller font */
            /* ADDED for gradual appearance */
            opacity: 0;
            transform: translateY(8px); /* Start slightly lower */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, background-color 0.15s ease-out; /* Combined transitions */
        }
        .schema-item.visible-item { /* ADDED class for visible state */
            opacity: 1;
            transform: translateY(0);
        }
        .schema-item:hover {
            background-color: rgba(0,0,0,0.04);
        }
        .schema-item svg.lucide { /* Changed from i.lucide */
            margin-right: 0.625rem; /* Adjusted from 1.2rem (testing value) to 10px */
            width: 0.9rem; /* Icon size */
            height: 0.9rem;
            color: var(--md-primary-color); /* Use primary color for icons */
            flex-shrink: 0;
        }
        
        .schema-database-item {
            font-weight: 500; /* Medium weight for DB names */
            color: var(--md-text-primary-on-background);
            margin-top: 0.5rem;
            /* ADDED: for clickability and icon styling */
            cursor: pointer;
        }
        .schema-database-item i.lucide {
             color: var(--md-primary-color-dark); /* Darker for DB icon */
        }

        .schema-table-item {
            margin-left: 1.25rem; /* Indent tables */
            color: var(--md-text-secondary-on-background);
            /* ADDED: for clickability and icon styling */
            cursor: pointer;
        }
        .schema-table-item strong {
            color: var(--md-text-primary-on-background);
            font-weight: 500;
        }
        .schema-table-item .toggle-icon {
            margin-left: auto; /* Pushes icon to the right */
            transition: transform 0.2s ease-in-out;
        }
        .schema-table-item.expanded .toggle-icon {
            transform: rotate(-180deg); /* Rotates chevron-down to look like chevron-up */
        }
        
        .schema-columns-list {
            margin-left: 2.5rem; /* Further indent columns */
            font-size: 0.8rem;
            color: var(--md-text-secondary-on-background);
            padding-left: 0.5rem;
            border-left: 1px dashed var(--md-border-color); /* Visual guide for columns */
            /* ADDED: for smooth collapse/expand animation */
            overflow: hidden;
            max-height: 0; /* Initially collapsed */
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Increased from 0.3s */
        }
        .schema-column {
            padding: 0.1rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* --- END NEW STYLES --- */

        /* ADDED: Wrapper for database content to animate its height */
        .database-content-wrapper {
            overflow: hidden;
            max-height: 0; /* Initially collapsed */
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Increased from 0.3s */
        }

        /* ADDED: Styles for header buttons to give them elevation */
        #config-toggle-btn, #schema-toggle-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #config-toggle-btn:hover, #schema-toggle-btn:hover {
            --tw-shadow: var(--md-elevation-2);
            --tw-shadow-colored: var(--md-elevation-2);
            transform: translateY(-1px);
        }
        #config-toggle-btn:active, #schema-toggle-btn:active {
            --tw-shadow: var(--md-elevation-1);
            --tw-shadow-colored: var(--md-elevation-1);
            transform: translateY(0px);
            transition-duration: 0.1s;
        }
        
        /* ADDED: Elevation for the main send button */
        #send-button:hover {
            box-shadow: var(--md-elevation-2);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-md flex justify-between items-center">
        <a href="/" id="header-link" class="text-xl font-bold flex items-center">
            <img id="header-db-icon" src="/static/DataFlow.png" alt="DataFlow Logo" class="mr-2 h-9 w-9" style="filter: brightness(0) invert(1);">
            DataFlow
        </a>
        <div class="flex items-center space-x-3">
            <button id="config-toggle-btn" class="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg text-sm flex items-center shadow">
                <i id="settings-icon" data-lucide="settings" class="mr-1 h-4 w-4 text-indigo-600"></i> Config
            </button>
            <button id="schema-toggle-btn" class="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg text-sm flex items-center shadow">
                <span id="schema-db-icon" class="mr-1"><i data-lucide="database" class="h-4 w-4 text-indigo-600"></i></span>
                <span id="schema-up-icon" class="mr-1 hidden"><i data-lucide="chevron-right" class="h-4 w-4 text-indigo-600"></i></span>
                <span id="schema-text">View Schema</span>
            </button>
        </div>
    </header>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Configuration Popup -->
    <div id="config-popup" class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-gray-800">Database Configuration</h3>
            <button id="close-config-btn" class="text-gray-500 hover:text-gray-700">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <form id="config-form" class="space-y-4 pt-2">
            <div class="input-group">
                <i data-lucide="server" class="icon h-4 w-4"></i>
                <input type="text" id="mysql-host" name="mysql-host" placeholder=" " class="bg-transparent">
                <label for="mysql-host" class="floating-label">MySQL Host</label>
            </div>
            <div class="input-group">
                <i data-lucide="user" class="icon h-4 w-4"></i>
                <input type="text" id="mysql-user" name="mysql-user" placeholder=" " class="bg-transparent" autocomplete="new-password">
                <label for="mysql-user" class="floating-label">MySQL User</label>
            </div>
            <div class="input-group">
                <i data-lucide="key-round" class="icon h-4 w-4"></i>
                <input type="password" id="mysql-password" name="mysql-password" placeholder=" " class="bg-transparent" autocomplete="new-password">
                <label for="mysql-password" class="floating-label">MySQL Password</label>
                <button type="button" class="toggle-password" data-target="mysql-password">
                    <i data-lucide="eye" class="h-4 w-4"></i>
                </button>
            </div>
            <div class="input-group">
                <i data-lucide="key-round" class="icon h-4 w-4"></i>
                <input type="password" id="gemini-api-key" name="gemini-api-key" placeholder=" " class="bg-transparent">
                <label for="gemini-api-key" class="floating-label">Gemini API Key</label>
                <button type="button" class="toggle-password" data-target="gemini-api-key">
                    <i data-lucide="eye" class="h-4 w-4"></i>
                </button>
            </div>
            <div class="pt-2">
                <button type="button" id="config-save-btn" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 button-primary">
                    <span id="config-save-text">Save Configuration</span>
                    <div id="config-save-spinner" class="hidden ml-2 flex items-center">
                        <!-- SVG Spinner will be inserted here by JS -->
                    </div>
                </button>
            </div>
        </form>
    </div>

    <!-- Main Content Area: Chat + Schema Sidebar -->
    <div id="main-content-wrapper" class="flex flex-1 overflow-hidden">

        <main id="chat-area" class="flex-1 overflow-hidden p-4 flex flex-col">
            <div id="chat-history" class="flex-1 overflow-y-auto mb-4 space-y-4 p-4 bg-white rounded-lg shadow">
                <div class="p-3 rounded-lg bg-blue-100 text-blue-800 max-w-xl mr-auto">
                    <p class="text-sm">Hello! Ask me something about the data (e.g., "Show me all employees in HR") or run a specific query using <code class="bg-blue-200 px-1 rounded">/run SELECT * FROM your_table LIMIT 10;</code>.</p>
                </div>
            </div>

            <div class="mt-auto p-4 bg-white rounded-lg shadow relative">
                <div id="slash-command-popup" class="absolute bottom-full left-0 mb-1 w-auto bg-white border border-gray-300 rounded-md shadow-lg z-20 hidden">
                    <!-- Suggestions will be added here by JS -->
                </div>
                <form id="chat-form" class="flex items-center space-x-3">
                    <div id="input-wrapper" class="flex-1 flex items-center border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition duration-150 ease-in-out overflow-hidden">
                        <span id="run-command-tag" class="hidden bg-blue-600 text-white text-sm font-semibold py-1 px-3 flex items-center cursor-default">
                            /run
                            <button type="button" id="remove-run-tag-btn" class="text-blue-200 hover:text-white focus:outline-none p-1">
                                <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                        </span>
                        <input type="text" id="message-input" placeholder="Type your message or /run command..." class="flex-1 px-4 py-2 focus:outline-none bg-transparent h-full text-sm" required>
                    </div>
                    <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full shadow transition duration-150 ease-in-out flex items-center justify-center h-10 w-10 relative">
                        <i data-lucide="arrow-up" id="send-icon" class="h-5 w-5 absolute"></i>
                        <div id="send-spinner" class="hidden absolute">
                            <!-- SVG Spinner will be inserted here by JS -->
                        </div>
                    </button>
                </form>
            </div>
        </main>

        <div id="schema-display" 
             class="bg-white text-sm transition-all duration-300 ease-in-out"> 
            <!-- Removed: border-gray-200, overflow-hidden, max-h-0, opacity-0, p-0, border-0. Applied via CSS rules and 'open' class -->
            <!-- Content will be dynamically inserted by JS, including spinner -->
            <!-- The header and refresh button are now part of the dynamic content or structured here -->
            <div id="schema-display-header">
                 <h3 class="font-semibold text-gray-700">Database Schema</h3>
                 <button id="refresh-schema-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded inline-flex items-center">
                    <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg> Refresh Schema
                </button>
            </div>
            <div id="schema-content" class="text-gray-600">
                <!-- Schema items will be loaded here -->
            </div>
        </div>

    </div> <!-- End #main-content-wrapper -->

    <script>
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon'); // Changed from sendText
        const sendSpinner = document.getElementById('send-spinner');
        const schemaDisplay = document.getElementById('schema-display');
        const schemaContent = document.getElementById('schema-content');
        const schemaToggleBtn = document.getElementById('schema-toggle-btn');
        const refreshSchemaBtn = document.getElementById('refresh-schema-btn');
        const configToggleBtn = document.getElementById('config-toggle-btn');
        const configPopup = document.getElementById('config-popup');
        const closeConfigBtn = document.getElementById('close-config-btn');
        const configForm = document.getElementById('config-form');

        // --- ADDED: Reference to new main content and chat area elements ---
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const chatArea = document.getElementById('chat-area');
        // --- END ADDED ---
        
        // --- Autocomplete /run command elements ---
        const inputWrapper = document.getElementById('input-wrapper');
        const runCommandTag = document.getElementById('run-command-tag');
        const removeRunTagBtn = document.getElementById('remove-run-tag-btn');
        const slashCommandPopup = document.getElementById('slash-command-popup');
        let isRunCommandActive = false;
        const originalPlaceholder = "Type your message or /run command...";
        const runCommandPlaceholder = "Enter SQL query (e.g., SELECT * FROM users)";

        // --- Helper Functions ---

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderMarkdown(text) {
            // Convert Markdown to HTML using marked.js
            const dirtyHtml = marked.parse(text);
            // Sanitize the HTML using DOMPurify to prevent XSS attacks
            const cleanHtml = DOMPurify.sanitize(dirtyHtml);
            return cleanHtml;
        }

        // ADDED: Helper function to create spinner SVG
        function createSpinnerSvg(extraClasses = "w-5 h-5 text-white animate-spin fill-white") {
            return `
                <svg aria-hidden="true" class="${extraClasses}" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            `;
        }

        function addMessageToChat(sender, messageHtml, messageType = 'info') {
            const messageDiv = document.createElement('div');
            let bgColor, textColor, alignment;

            if (sender === 'user') {
                bgColor = 'bg-indigo-100';
                textColor = 'text-indigo-900';
                alignment = 'ml-auto'; // Align user messages to the right
            } else { // Assistant messages
                bgColor = 'bg-gray-100';
                textColor = 'text-gray-900';
                alignment = 'mr-auto'; // Align assistant messages to the left

                if (messageType === 'error') {
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                } else if (messageType === 'result') {
                     bgColor = 'bg-green-50'; // Lighter green for results
                     textColor = 'text-gray-900'; // Keep text dark for readability
                }
            }

            messageDiv.className = `p-3 rounded-lg ${bgColor} ${textColor} max-w-3xl ${alignment} prose prose-sm max-w-none`; // Use prose for markdown styling
            messageDiv.innerHTML = messageHtml; // Use innerHTML as we are injecting HTML
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }

        function createTableHtml(columns, results) {
            if (!results || results.length === 0) {
                return '<p class="text-sm text-gray-600 italic">Query returned no results.</p>';
            }
            if (!columns || columns.length === 0) {
                 return '<p class="text-sm text-red-600">Error: Missing column names for results.</p>';
            }

            let tableHtml = '<div class="results-table"><table><thead><tr>';
            columns.forEach(col => {
                tableHtml += `<th>${escapeHtml(col)}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            results.forEach(row => {
                tableHtml += '<tr>';
                // Ensure row is an array or tuple before iterating
                if (Array.isArray(row) || row instanceof Object && typeof row[Symbol.iterator] === 'function') {
                     // Check if columns length matches row length
                     if (row.length !== columns.length) {
                         console.warn("Row length mismatch:", row, "Columns:", columns);
                         // Add placeholder cells or handle error appropriately
                         tableHtml += `<td colspan="${columns.length}" class="text-red-500 italic">Data format error: row length mismatch</td>`;
                     } else {
                        row.forEach(cell => {
                            // Handle null or undefined values gracefully
                            const cellContent = cell === null || cell === undefined ? 'NULL' : cell;
                            tableHtml += `<td>${escapeHtml(String(cellContent))}</td>`; // Convert all cells to string before escaping
                        });
                     }
                } else {
                     // Handle cases where row might not be iterable or is a single value
                     console.warn("Unexpected row format:", row);
                     tableHtml += `<td colspan="${columns.length}" class="text-red-500 italic">Data format error: unexpected row type</td>`;
                }
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table></div>';
            if (results.length === 100) {
                tableHtml += '<p class="text-xs text-gray-500 italic mt-1">Displaying up to 100 rows. The actual result set may be larger.</p>';
            }
            return tableHtml;
        }

        function setLoadingState(isLoading) {
            const sendIcon = document.getElementById('send-icon');
            const sendSpinner = document.getElementById('send-spinner');
            const animationDuration = 150; // ms, matches the CSS animation time

            if (isLoading) {
                messageInput.disabled = true;
                sendButton.disabled = true;
                
                sendIcon.classList.add('icon-fade-out');
                
                setTimeout(() => {
                    sendIcon.classList.add('hidden');
                    sendIcon.classList.remove('icon-fade-out');

                    sendSpinner.classList.remove('hidden');
                    sendSpinner.classList.add('icon-fade-in');
                    sendSpinner.innerHTML = createSpinnerSvg();
                }, animationDuration);

            } else {
                messageInput.disabled = false;
                sendButton.disabled = false;
                
                sendSpinner.classList.add('icon-fade-out');
                
                setTimeout(() => {
                    sendSpinner.classList.add('hidden');
                    sendSpinner.classList.remove('icon-fade-out');
                    sendSpinner.innerHTML = '';

                    sendIcon.classList.remove('hidden');
                    sendIcon.classList.remove('icon-fade-out'); // Ensure fade-out is not lingering
                    sendIcon.classList.add('icon-fade-in');
                    
                    // Clean up the fade-in class after it has run
                    setTimeout(() => {
                        sendIcon.classList.remove('icon-fade-in');
                    }, animationDuration);

                }, animationDuration);

                messageInput.focus();
            }
        }

        // --- API Interaction ---

        // MODIFY fetchSchema to handle nested structure
        async function fetchSchema(showLoading = true) {
            // NEW: Record start time for minimum loader display
            let startTime = 0;
            const minLoadingTime = 500; // Minimum loader display time in ms

            if (showLoading) {
                 schemaContent.innerHTML = '<div class="flex items-center justify-center p-4"><span class="mr-2">Loading schema...</span>' + createSpinnerSvg("w-4 h-4 text-gray-400 animate-spin fill-blue-600") + '</div>';
                 startTime = Date.now(); // Record time after loader is shown
            }

            // NEW: Helper function to actually update content and apply animations
            const performVisualUpdate = (htmlToSet, animate) => {
                schemaContent.innerHTML = htmlToSet;
                lucide.createIcons(); // Create icons first

                const items = schemaContent.querySelectorAll('.schema-item');
                const initialDelay = 0; // Small base delay (ms) before the first item starts
                const staggerAmount = 5;  // Delay between each subsequent item (ms)

                if (animate) {
                    // Use requestAnimationFrame to ensure initial styles are painted before animation starts
                    requestAnimationFrame(() => {
                        items.forEach((item, index) => {
                            setTimeout(() => {
                                item.classList.add('visible-item');
                            }, initialDelay + (index * staggerAmount)); 
                        });
                    });
                } else {
                    // If not animating, make them visible immediately (can also be in RAF for consistency)
                    requestAnimationFrame(() => {
                        items.forEach(item => {
                            item.classList.add('visible-item');
                        });
                    });
                }
            };

            // REVISED: Helper function to update content after minimum delay
            const updateContentWithDelay = (htmlToSet) => {
                if (showLoading) {
                    const elapsedTime = Date.now() - startTime;
                    const delayForLoader = Math.max(0, minLoadingTime - elapsedTime); // Ensure delay is not negative
                    setTimeout(() => {
                        performVisualUpdate(htmlToSet, true); // Animate after loader
                    }, delayForLoader);
                } else {
                    // If not showing loading (e.g., initial silent load), update immediately without animation for entry
                    performVisualUpdate(htmlToSet, false);
                }
            };

             try {
                 const response = await fetch('/schema');
                 if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { // Try to get more specific error from backend
                        const errData = await response.json();
                        // Adjust error path based on potential backend response structure
                        errorMsg = errData.detail || (errData.error && errData.error.schema && Array.isArray(errData.error.schema) ? errData.error.schema.join(', ') : errorMsg);
                    } catch(e) { /* ignore if body isn't json */ }
                    throw new Error(errorMsg);
                 }
                 const data = await response.json();
                 const schema = data.schema; // Expected format: { dbName: { tableName: [columns] } } or { error: { schema: ["message"] } }

                 let finalSchemaHtml = ''; // Variable to store the fully constructed HTML

                 // Check for the top-level error structure first
                 if (schema && typeof schema === 'object' && schema.error && schema.error.schema && Array.isArray(schema.error.schema)) {
                    finalSchemaHtml = `<div class="p-4"><p class="text-red-600">Error fetching schema: ${escapeHtml(schema.error.schema.join(', '))}</p></div>`;
                 } else if (schema && typeof schema === 'object' && Object.keys(schema).length > 0) {
                     let builtSchemaContent = ''; // Temporary string to build schema details
                     // Iterate through Databases
                     for (const dbName in schema) {
                         if (schema.hasOwnProperty(dbName)) {
                             // ADDED: group class, toggle-icon, and made it initially not expanded
                             builtSchemaContent += `<div class="schema-item schema-database-item group"><i data-lucide="database"></i>${escapeHtml(dbName)}<i data-lucide="chevron-down" class="toggle-icon h-4 w-4 text-gray-400 group-hover:text-gray-600"></i></div>`;
                             // ADDED: Wrapper for all tables and columns under this DB, hidden by default
                             builtSchemaContent += '<div class="database-content-wrapper">';
                              const tables = schema[dbName]; // This could be { tableName: [cols] } or { error: ["msg"] }
 
                              // Check if the value for the dbName is an error object
                              if (typeof tables === 'object' && tables !== null && tables.error && Array.isArray(tables.error)) {
                                  builtSchemaContent += `<div class="schema-item schema-table-item italic text-red-500"><i data-lucide="alert-triangle"></i>Error: ${escapeHtml(tables.error.join(', '))}</div>`;
                              }
                              // Check if it's a valid tables object (and not the error object)
                              else if (typeof tables === 'object' && tables !== null && !tables.error) {
                                  if (Object.keys(tables).length > 0) {
                                      // Iterate through Tables within the Database
                                      for (const tableName in tables) {
                                          if (tables.hasOwnProperty(tableName) && Array.isArray(tables[tableName])) {
                                              // ADDED: group class for hover states on icon, and toggle-icon span
                                              builtSchemaContent += `<div class="schema-item schema-table-item group"><i data-lucide="table-2"></i><strong>${escapeHtml(tableName)}</strong><i data-lucide="chevron-down" class="toggle-icon h-4 w-4 text-gray-400 group-hover:text-gray-600"></i></div>`;
                                               if (tables[tableName].length > 0) {
                                                   // ADDED: hidden class to collapse columns by default
                                                   builtSchemaContent += '<div class="schema-columns-list">';
                                                    tables[tableName].forEach(column => {
                                                        builtSchemaContent += `<div class="schema-column">${escapeHtml(column)}</div>`;
                                                    });
                                                   builtSchemaContent += '</div>';
                                               } else {
                                                   builtSchemaContent += '<div class="schema-columns-list italic">No columns found.</div>';
                                               }
                                          }
                                      }
                                  } else {
                                      builtSchemaContent += '<div class="schema-item schema-table-item italic"><i data-lucide="info"></i>No tables found.</div>';
                                  }
                              } else {
                                  // Handle unexpected format for the database entry
                                  builtSchemaContent += '<div class="schema-item schema-table-item italic"><i data-lucide="info"></i>No table data.</div>';
                              }
                          builtSchemaContent += '</div>'; // Close database-content-wrapper
                          }
                      }
                      finalSchemaHtml = builtSchemaContent || '<div class="p-4 text-gray-500"><i data-lucide="search-x" class="inline-block mr-2"></i>No databases or tables found.</div>';
                  } else {
                      // This case handles empty schema object {} or other non-error, non-object types
                      finalSchemaHtml = '<div class="p-4 text-gray-500"><i data-lucide="database-zap" class="inline-block mr-2"></i>No schema found or unable to fetch.</div>';
                  }
                  updateContentWithDelay(finalSchemaHtml); // Use the helper to update content
              } catch (error) {
                  console.error('Error fetching schema:', error);
                  // Ensure error.message is escaped
                  const errorHtml = `<div class="p-4 text-red-600"><i data-lucide="alert-circle" class="inline-block mr-2"></i>Failed to load schema. ${escapeHtml(error.message)}</div>`;
                  updateContentWithDelay(errorHtml); // Use the helper to update content for errors
              }
        }

        async function sendMessage(message) {
            addMessageToChat('user', `<p>${escapeHtml(message)}</p>`); // Display user message immediately
            messageInput.value = ''; // Clear input
            setLoadingState(true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });

                if (!response.ok) {
                     // Try to get error details from response body
                     let errorDetail = `HTTP error! status: ${response.status}`;
                     try {
                         const errorData = await response.json();
                         errorDetail = errorData.detail || errorData.content || errorDetail;
                     } catch (e) { /* Ignore if body isn't JSON */ }
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                let assistantMessageHtml = '';

                if (data.type === 'result') {
                    assistantMessageHtml += `<p class="font-semibold">Generated SQL:</p><pre><code class="language-sql">${escapeHtml(data.query || '')}</code></pre>`;
                    assistantMessageHtml += createTableHtml(data.columns, data.results);
                    if (data.insights) {
                        // Render insights as Markdown
                        assistantMessageHtml += renderMarkdown(data.insights);
                    }
                } else if (data.type === 'info') {
                     // Render info potentially containing markdown (like code blocks)
                     assistantMessageHtml += renderMarkdown(data.content);
                } else if (data.type === 'error') {
                     // Render error potentially containing markdown (like code blocks)
                     assistantMessageHtml += renderMarkdown(data.content);
                     if (data.ai_explanation) {
                        assistantMessageHtml += renderMarkdown(data.ai_explanation); // Render AI explanation as Markdown
                     }
                } else if (data.type === 'confirm_execution') {
                    // This case is now handled by addConfirmationMessageToChat
                    // It will set loading state to false to re-enable input while confirm buttons are visible.
                    addConfirmationMessageToChat(data.message, data.query);
                    return; // Return early as we don't want to call addMessageToChat or setLoadingState(false) again here
                } else {
                    assistantMessageHtml = `<p>${escapeHtml(String(data.content || 'Received unexpected response format.'))}</p>`;
                }

                addMessageToChat('assistant', assistantMessageHtml, data.type);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('assistant', `<p>Sorry, I encountered an error: ${escapeHtml(error.message)}</p>`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        // --- ADDED: Functions for handling query confirmation ---
        function addConfirmationMessageToChat(messageText, queryToConfirm) {
            const messageDiv = document.createElement('div');
            // Using a distinct style for confirmation prompts
            messageDiv.className = `p-3 rounded-lg bg-yellow-100 border border-yellow-300 text-yellow-800 max-w-3xl mr-auto prose prose-sm max-w-none shadow`;

            let htmlContent = `<p class="font-semibold">${escapeHtml(messageText)}</p>`;
            htmlContent += `<pre class="bg-yellow-50 p-2 rounded mt-2 border border-yellow-200"><code class="language-sql text-black">${escapeHtml(queryToConfirm)}</code></pre>`;
            htmlContent += `<div class="mt-3 flex space-x-2">
                                <button class="confirm-execute-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 px-4 rounded text-sm shadow-sm transition-colors duration-150" data-query="${escapeHtml(queryToConfirm)}">Execute</button>
                                <button class="cancel-execute-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-4 rounded text-sm shadow-sm transition-colors duration-150">Cancel</button>
                             </div>`;

            messageDiv.innerHTML = htmlContent;
            chatHistory.appendChild(messageDiv);

            // Add event listeners to the new buttons
            messageDiv.querySelector('.confirm-execute-btn').addEventListener('click', async function() {
                const query = this.dataset.query;
                // Update the current message to "Executing..."
                const parentMessageBubble = this.closest('.p-3.rounded-lg');
                if (parentMessageBubble) {
                    parentMessageBubble.innerHTML = `<p class="font-semibold text-blue-700">Executing query:</p><pre class="bg-blue-50 p-2 rounded mt-2 border border-blue-200"><code class="language-sql text-blue-900">${escapeHtml(query)}</code></pre><p class="mt-2 text-sm text-gray-600 italic">Please wait...</p>`;
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
                await executeConfirmedQuery(query); // This will add a *new* message with the result
                // ADDED: Update the original confirmation bubble after execution
                if (parentMessageBubble) {
                    parentMessageBubble.innerHTML = `<p class="text-sm text-gray-600 italic">The confirmed query execution has been processed. See result in the new message below.</p>`;
                    // Optionally, change its styling to be less prominent or more indicative of a completed action
                    parentMessageBubble.className = `p-3 rounded-lg bg-gray-50 border border-gray-200 text-gray-500 max-w-3xl mr-auto prose prose-sm max-w-none shadow-sm`;
                }
            });

            messageDiv.querySelector('.cancel-execute-btn').addEventListener('click', function() {
                // Replace current message with cancellation
                const parentMessageBubble = this.closest('.p-3.rounded-lg');
                if (parentMessageBubble) {
                     parentMessageBubble.className = `p-3 rounded-lg bg-gray-100 text-gray-600 max-w-3xl mr-auto prose prose-sm max-w-none italic shadow`;
                    parentMessageBubble.innerHTML = `<p>Execution cancelled by user.</p>`;
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });

            chatHistory.scrollTop = chatHistory.scrollHeight;
            setLoadingState(false); // Ensure main input is usable while confirmation is shown
        }

        async function executeConfirmedQuery(query) {
            // setLoadingState(true); // Main input is already re-enabled by addConfirmationMessageToChat, keep it that way.
                                 // We want the user to be able to type a new query if they wish, while the confirmed one executes.
                                 // However, we should show a specific loading indicator for this execution if possible, or rely on the message update.
            // For now, the message update to "Executing..." will serve as the primary indicator.

            try {
                const response = await fetch('/execute_confirmed_sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                });

                if (!response.ok) {
                    let errorDetail = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.content || errorData.detail || errorDetail;
                    } catch (e) { /* Ignore if body isn't JSON */ }
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                let resultMessageHtml = '';

                // Process response from /execute_confirmed_sql (similar to /chat)
                // The 'assistant' will now deliver the outcome of the confirmed query.
                if (data.type === 'info') {
                    resultMessageHtml = renderMarkdown(data.content);
                } else if (data.type === 'error') {
                    resultMessageHtml = renderMarkdown(data.content); // Error messages can also contain markdown (like code blocks)
                    if (data.ai_explanation) {
                        resultMessageHtml += renderMarkdown(data.ai_explanation); // Render AI explanation as Markdown
                    }
                } else if (data.type === 'result') { // Should be rare for this flow but handle
                    resultMessageHtml += `<p class="font-semibold">Query Executed:</p><pre><code class="language-sql">${escapeHtml(data.query || '')}</code></pre>`;
                    resultMessageHtml += createTableHtml(data.columns, data.results);
                    if (data.insights) {
                        resultMessageHtml += renderMarkdown(data.insights);
                    }
                } else {
                    resultMessageHtml = `<p>${escapeHtml(String(data.content || 'Received unexpected response format.'))}</p>`;
                }
                // Add this result as a new message from the assistant
                addMessageToChat('assistant', resultMessageHtml, data.type);

            } catch (error) {
                console.error('Error executing confirmed query:', error);
                addMessageToChat('assistant', `<p>Sorry, I encountered an error during the confirmed execution: ${escapeHtml(error.message)}</p>`, 'error');
            } finally {
                // setLoadingState(false); // No need to call setLoadingState(false) here as it wasn't set to true at the start of this func.
            }
        }
        // --- END: Functions for handling query confirmation ---

        // --- ADDED: Toast Notification Function ---
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('Toast container not found!');
                return;
            }

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`; // e.g., toast toast-success

            const content = document.createElement('div');
            content.className = 'toast-content';
            content.textContent = message;

            const closeButton = document.createElement('button');
            closeButton.className = 'toast-close';
            closeButton.innerHTML = '&times;'; // Simple 'x'
            closeButton.onclick = () => {
                toast.classList.add('toast-remove');
                toast.addEventListener('animationend', () => {
                    if (container.contains(toast)) { // Check if still a child before removing
                        container.removeChild(toast);
                    }
                });
            };

            toast.appendChild(content);
            toast.appendChild(closeButton);
            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                // Check if toast is still in DOM (user might have closed it manually)
                if (container.contains(toast) && !toast.classList.contains('toast-remove')) {
                    toast.classList.add('toast-remove');
                    toast.addEventListener('animationend', () => {
                         if (container.contains(toast)) { // Double check before removing
                            container.removeChild(toast);
                         }
                    });
                }
            }, duration);
        }
        // --- END: Toast Notification Function ---

        // --- Configuration Popup Functions ---
        
        async function saveConfig(config) {
            // Set loading state
            const saveBtn = document.getElementById('config-save-btn');
            const saveText = document.getElementById('config-save-text'); 
            const saveSpinner = document.getElementById('config-save-spinner');
            
            saveBtn.disabled = true;
            saveText.classList.add('opacity-75');
            saveSpinner.classList.remove('hidden');
            saveSpinner.innerHTML = createSpinnerSvg("w-4 h-4 text-white animate-spin fill-indigo-300"); // Use helper with specific classes
            
            try {
                // Send configuration to backend
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mysql_host: config.mysqlHost,
                        mysql_user: config.mysqlUser,
                        mysql_password: config.mysqlPassword,
                        gemini_api_key: config.geminiApiKey
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // REMOVED: No longer saving to localStorage
                // localStorage.setItem('sqlAssistantConfig', JSON.stringify(config));
                
                if (data.status === 'success') {
                    const connectionWarnings = [];
                    if (data.mysql_connection !== 'success') {
                        connectionWarnings.push(`MySQL connection warning: ${data.mysql_connection}`);
                    }
                    if (data.gemini_api !== 'success') {
                        connectionWarnings.push(`Gemini API warning: ${data.gemini_api}`);
                    }
                    
                    if (connectionWarnings.length > 0) {
                        showToast(`Configuration saved with warnings:\n${connectionWarnings.join('\n')}\n\nChanges have been applied and .env file updated.`, 'warning');
                    } else {
                        showToast('Configuration successfully saved and applied! No restart required.', 'success');
                    }
                    
                    // Reload schema to reflect any database connection changes
                    fetchSchema(true);
                    // ADDED: Re-fetch config to update the form state (e.g., placeholder for password)
                    fetchAndApplyConfig(); 
                } else {
                    showToast(`Configuration status: ${data.message}`, 'info');
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                showToast(`Error saving configuration: ${error.message}. Please try again.`, 'error');
                // REMOVED: No longer saving to localStorage as a fallback
                // localStorage.setItem('sqlAssistantConfig', JSON.stringify(config));
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveText.classList.remove('opacity-75');
                saveSpinner.classList.add('hidden');
                saveSpinner.innerHTML = ""; // Clear spinner
            }
        }
        
        async function fetchAndApplyConfig() {
            try {
                const response = await fetch('/config_status');
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                const config = await response.json();
                
                document.getElementById('mysql-host').value = config.mysql_host || '';
                document.getElementById('mysql-user').value = config.mysql_user || '';
                
                const passwordInput = document.getElementById('mysql-password');
                const passwordLabel = document.querySelector('label[for="mysql-password"]');
                if (config.mysql_password_set) {
                    passwordInput.value = '';
                    passwordInput.placeholder = ' '; // Keep placeholder empty for label
                    passwordLabel.textContent = 'MySQL Password (already set)';
                } else {
                    passwordInput.value = '';
                    passwordInput.placeholder = ' '; // Use a space for floating label to work
                    passwordLabel.textContent = 'MySQL Password';
                }

                const geminiInput = document.getElementById('gemini-api-key');
                const geminiLabel = document.querySelector('label[for="gemini-api-key"]');
                if (config.gemini_api_key_set) {
                    geminiInput.value = '';
                    geminiInput.placeholder = ' '; // Keep placeholder empty for label
                    geminiLabel.textContent = 'Gemini API Key (already set)';
                } else {
                    geminiInput.value = '';
                    geminiInput.placeholder = ' '; // Use a space for floating label to work
                    geminiLabel.textContent = 'Gemini API Key';
                }

            } catch (error) {
                console.error('Error fetching configuration status:', error);
                showToast(`Could not fetch server configuration: ${error.message}`, 'error');
            }
        }

        // --- Autocomplete and /run Tag Functions ---
        function showRunCommandTag() {
            runCommandTag.classList.remove('hidden');
            messageInput.placeholder = runCommandPlaceholder;
            isRunCommandActive = true;
            messageInput.value = '';
            hideSlashCommandPopup();
            messageInput.focus();
        }

        function hideRunCommandTag() {
            runCommandTag.classList.add('hidden');
            messageInput.placeholder = originalPlaceholder;
            isRunCommandActive = false;
            messageInput.value = '';
            messageInput.focus();
        }

        function showSlashCommandPopup() {
            const inputValue = messageInput.value;
            // console.log("[Debug] inputValue:", inputValue);

            const startsWithSlash = inputValue.startsWith('/');
            // console.log("[Debug] startsWithSlash:", startsWithSlash);

            const isLengthOne = inputValue.length === 1;
            // console.log("[Debug] isLengthOne (inputValue.length === 1):", isLengthOne);

            let subStringLower = "";
            if (inputValue.length > 1) {
                subStringLower = inputValue.substring(1).toLowerCase();
            }
            // console.log("[Debug] subStringLower (inputValue.substring(1).toLowerCase()):", subStringLower);

            const runStartsWithSub = "run".startsWith(subStringLower); // Corrected: removed leading slash from "run"
            // console.log("[Debug] \"run\".startsWith(subStringLower):", runStartsWithSub);

            const shouldShowPopup = startsWithSlash && (isLengthOne || (inputValue.length > 1 && runStartsWithSub));
            // console.log("[Debug] Overall condition (startsWithSlash && (isLengthOne || (inputValue.length > 1 && runStartsWithSub))):", shouldShowPopup);

            if (shouldShowPopup) {
                slashCommandPopup.innerHTML = ''; // Clear previous suggestions
                const suggestionDiv = document.createElement('div');
                suggestionDiv.textContent = '/run';
                suggestionDiv.dataset.command = '/run';
                suggestionDiv.addEventListener('click', () => {
                    showRunCommandTag();
                });
                slashCommandPopup.appendChild(suggestionDiv);
                slashCommandPopup.classList.remove('hidden');
            } else {
                hideSlashCommandPopup();
            }
        }

        function hideSlashCommandPopup() {
            slashCommandPopup.classList.add('hidden');
            slashCommandPopup.innerHTML = '';
        }

        // --- Event Listeners ---

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const queryPart = messageInput.value.trim();
            let messageToSend;

            if (isRunCommandActive) {
                if (queryPart) {
                    messageToSend = "/run " + queryPart;
                } else {
                    showToast("Please enter an SQL query to run.", "warning", 3000);
                    messageInput.focus();
                    return;
                }
            } else {
                messageToSend = queryPart;
            }

            if (messageToSend) {
                sendMessage(messageToSend);
                if (isRunCommandActive) {
                    hideRunCommandTag();
                }
            }
        });

        schemaToggleBtn.addEventListener('click', () => {
            const isOpen = schemaDisplay.classList.contains('open');
            const dbIcon = document.getElementById('schema-db-icon');
            const upIcon = document.getElementById('schema-up-icon');
            const schemaText = document.getElementById('schema-text');

            // Prevent re-triggering animations if already in progress by cleaning up
            dbIcon.classList.remove('schema-icon-animate-out', 'schema-icon-animate-in');
            upIcon.classList.remove('schema-icon-animate-out', 'schema-icon-animate-in');
            dbIcon.style.opacity = '';
            dbIcon.style.transform = '';
            upIcon.style.opacity = '';
            upIcon.style.transform = '';

            if (!isOpen) { // Schema is opening
                schemaDisplay.classList.add('open');
                chatArea.style.marginRight = '320px'; // ADDED: Make space for sidebar (width of sidebar)
                schemaText.textContent = 'Hide Schema';

                // Animate out dbIcon
                dbIcon.classList.add('schema-icon-animate-out');
                dbIcon.addEventListener('animationend', function handleDbAnimOut() {
                    dbIcon.classList.add('hidden');
                    dbIcon.classList.remove('schema-icon-animate-out'); // Clean up animation class

                    // Animate in upIcon
                    upIcon.classList.remove('hidden');
                    void upIcon.offsetWidth; // Force reflow before adding new animation class
                    upIcon.classList.add('schema-icon-animate-in');
                    upIcon.addEventListener('animationend', function handleUpAnimIn() {
                        upIcon.classList.remove('schema-icon-animate-in'); // Clean up animation class
                    }, { once: true });
                }, { once: true });
                
                const currentHTML = schemaContent.innerHTML;
                const trimmedContent = currentHTML.trim();

                const isEmptyOrPlaceholder = trimmedContent.startsWith("<!--") || trimmedContent === "";
                const isLoading = currentHTML.includes('Loading schema...');
                const hasFailedOrIsEmptyBackend = currentHTML.includes('Failed to load schema') ||
                                  currentHTML.includes('Error fetching schema') ||
                                  currentHTML.includes('No databases or tables found, or unable to fetch schema') ||
                                  currentHTML.includes('No databases or tables found.');

                const needsFetching = isEmptyOrPlaceholder || isLoading || hasFailedOrIsEmptyBackend;
                if (needsFetching) {
                   fetchSchema();
                }
            } else {
                schemaDisplay.classList.remove('open');
                chatArea.style.marginRight = '0';
                schemaText.textContent = 'View Schema';

                // Animate out upIcon
                upIcon.classList.add('schema-icon-animate-out');
                upIcon.addEventListener('animationend', function handleUpAnimOut() {
                    upIcon.classList.add('hidden');
                    upIcon.classList.remove('schema-icon-animate-out');

                    // Animate in dbIcon
                    dbIcon.classList.remove('hidden');
                    void dbIcon.offsetWidth; // Force reflow
                    dbIcon.classList.add('schema-icon-animate-in');
                    dbIcon.addEventListener('animationend', function handleDbAnimIn() {
                        dbIcon.classList.remove('schema-icon-animate-in');
                    }, { once: true });
                }, { once: true });
            }
        });

        refreshSchemaBtn.addEventListener('click', () => {
            fetchSchema(true);
        });
        
        configToggleBtn.addEventListener('click', () => {
            const settingsIcon = document.getElementById('settings-icon');
            
            if (configPopup.classList.contains('visible')) {
                configPopup.classList.remove('visible');
                
                settingsIcon.classList.remove('settings-icon-rotate-cw');
                settingsIcon.classList.add('settings-icon-rotate-ccw');
            } else {
                configPopup.classList.add('visible');
                
                settingsIcon.classList.remove('settings-icon-rotate-ccw');
                settingsIcon.classList.add('settings-icon-rotate-cw');
                
                // REMOVED: loadConfig();
            }
        });
        
        closeConfigBtn.addEventListener('click', () => {
            configPopup.classList.remove('visible');
        });
        
        // MODIFIED: Changed from 'submit' event on form to 'click' event on button
        document.getElementById('config-save-btn').addEventListener('click', async () => {
            const config = {
                mysqlHost: document.getElementById('mysql-host').value || "localhost",
                mysqlUser: document.getElementById('mysql-user').value || "root",
                mysqlPassword: document.getElementById('mysql-password').value || "root",
                geminiApiKey: document.getElementById('gemini-api-key').value || ""
            };
            await saveConfig(config);
            configPopup.classList.remove('visible');
        });

        messageInput.addEventListener('input', () => {
            const inputValue = messageInput.value;
            if (isRunCommandActive) {
                hideSlashCommandPopup();
                return;
            }

            if (inputValue.startsWith('/')) {
                showSlashCommandPopup();
                if (inputValue === "/run ") {
                    showRunCommandTag();
                }
            } else {
                hideSlashCommandPopup();
            }
        });

        removeRunTagBtn.addEventListener('click', () => {
            hideRunCommandTag();
        });
        
        document.addEventListener('click', function(event) {
            if (!slashCommandPopup.classList.contains('hidden')) {
                const isClickInsidePopup = slashCommandPopup.contains(event.target);
                const isClickOnInput = messageInput.contains(event.target);
                if (!isClickInsidePopup && !isClickOnInput) {
                    hideSlashCommandPopup();
                }
            }
        });

        // --- ADDED: Event listener for schema table toggling ---
        schemaContent.addEventListener('click', function(event) {
            const dbItem = event.target.closest('.schema-database-item');

            if (dbItem) {
                dbItem.classList.toggle('expanded');
                const dbContentWrapper = dbItem.nextElementSibling;
                if (dbContentWrapper && dbContentWrapper.classList.contains('database-content-wrapper')) {
                    if (dbContentWrapper.style.maxHeight && dbContentWrapper.style.maxHeight !== '0px') {
                        // Collapse the database content
                        dbContentWrapper.style.maxHeight = '0px';
                    } else {
                        // Expand the database content to its own scroll height
                        dbContentWrapper.style.maxHeight = dbContentWrapper.scrollHeight + 'px';
                    }
                }
            } else {
                const tableItem = event.target.closest('.schema-table-item');
                if (tableItem) {
                    tableItem.classList.toggle('expanded');
                    const columnsList = tableItem.nextElementSibling;
                    if (columnsList && columnsList.classList.contains('schema-columns-list')) {
                        const parentWrapper = tableItem.closest('.database-content-wrapper');

                        if (columnsList.style.maxHeight && columnsList.style.maxHeight !== '0px') {
                            // Collapse the column list
                            const listHeight = columnsList.scrollHeight;
                            columnsList.style.maxHeight = '0px';
                            // Adjust parent wrapper's height
                            if (parentWrapper && parentWrapper.style.maxHeight !== '0px') {
                                parentWrapper.style.maxHeight = (parseInt(parentWrapper.style.maxHeight) - listHeight) + 'px';
                            }
                        } else {
                            // Expand the column list
                            const listHeight = columnsList.scrollHeight;
                            columnsList.style.maxHeight = listHeight + 'px';
                            // Adjust parent wrapper's height
                            if (parentWrapper && parentWrapper.style.maxHeight !== '0px') {
                                parentWrapper.style.maxHeight = (parseInt(parentWrapper.style.maxHeight) + listHeight) + 'px';
                            }
                        }
                    }
                }
            }
            // Ensure icons are rendered/updated after any DOM change that might affect them.
            lucide.createIcons(); 
        });
        // --- END ADDED ---

        // --- ADDED: Event listeners for dynamic placeholders in config ---
        function setupDynamicPlaceholder(inputId, placeholderText) {
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                inputElement.addEventListener('focus', function() {
                    const label = document.querySelector(`label[for="${inputId}"]`);
                    // Only add the placeholder if the label indicates the value is already set
                    if (label && label.textContent.includes('(already set)')) {
                        this.placeholder = placeholderText;
                    }
                });
                inputElement.addEventListener('blur', function() {
                    // Always clear the placeholder on blur to allow the label to float back down
                    this.placeholder = ' ';
                });
            }
        }
        
        setupDynamicPlaceholder('mysql-password', 'Enter new password to update');
        setupDynamicPlaceholder('gemini-api-key', 'Enter new key to update');
        // --- END ADDED ---

        // --- Initial Setup ---

        lucide.createIcons();

        // Page load animation for header icon
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndApplyConfig(); // Fetch config on page load
            const headerDbIcon = document.getElementById('header-db-icon');
            if (headerDbIcon) {
                headerDbIcon.classList.add('icon-rotate-onload');
                headerDbIcon.addEventListener('animationend', () => {
                    headerDbIcon.classList.remove('icon-rotate-onload');
                }, { once: true });
            }
        });

        // --- Event Listeners ---

        // ADDED: Event listener for password visibility toggles
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetInputId = this.dataset.target;
                const targetInput = document.getElementById(targetInputId);
                
                if (targetInput) {
                    if (targetInput.type === 'password') {
                        targetInput.type = 'text';
                        // Replace the icon inside the button
                        this.innerHTML = '<i data-lucide="eye-off" class="h-4 w-4"></i>';
                    } else {
                        targetInput.type = 'password';
                        // Replace it back
                        this.innerHTML = '<i data-lucide="eye" class="h-4 w-4"></i>';
                    }
                    // Tell Lucide to create the new icon
                    lucide.createIcons();
                }
            });
        });

    </script>
</body>
</html>