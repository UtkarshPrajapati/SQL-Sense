<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataFlow</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Ensure code blocks wrap */
        pre {
            white-space: pre-wrap;       /* Since CSS 2.1 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
        /* Style for generated tables */
        .results-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            margin-top: 0.5rem; /* mt-2 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        .results-table th {
            background-color: #f8fafc; /* Tailwind slate-50 */
            position: sticky; /* Keep headers visible */
            top: 0;
            z-index: 10;
        }
        .results-table tbody tr:nth-child(even) {
            background-color: #f8fafc; /* Tailwind slate-50 */
        }
        .results-table tbody tr:hover {
            background-color: #f1f5f9; /* Tailwind slate-100 */
        }
        /* Config popup styles */
        #config-popup {
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 50;
            width: 300px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            /* Animation settings - more dramatic slide effect */
            opacity: 0;
            transform: translateY(-30px);
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none;
            display: block;
            visibility: hidden;
            /* Add a scale effect for more drama */
            transform-origin: top right;
            transform: translateY(-30px) scale(0.95);
        }
        #config-popup.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
            pointer-events: auto;
        }
        /* Add animation debug outlines if needed */
        #config-popup.debug-animation {
            outline: 2px solid red;
        }
        
        /* Settings icon rotation animation */
        @keyframes rotate-cw {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(180deg); }
        }
        
        @keyframes rotate-ccw {
            0% { transform: rotate(180deg); }
            100% { transform: rotate(0deg); }
        }
        
        .settings-icon-rotate-cw {
            animation: rotate-cw 0.5s ease forwards;
        }
        
        .settings-icon-rotate-ccw {
            animation: rotate-ccw 0.5s ease forwards;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-md flex justify-between items-center">
        <a href="/" class="text-xl font-bold flex items-center">
            <i data-lucide="database" class="mr-2"></i> DataFlow
        </a>
        <div class="flex items-center space-x-3">
            <button id="config-toggle-btn" class="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg shadow text-sm transition duration-150 ease-in-out flex items-center">
                <i id="settings-icon" data-lucide="settings" class="mr-1 h-4 w-4 text-indigo-600"></i> Config
            </button>
            <button id="schema-toggle-btn" class="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg shadow text-sm transition duration-150 ease-in-out flex items-center">
                <span id="schema-db-icon" class="mr-1"><i data-lucide="database" class="h-4 w-4 text-indigo-600"></i></span>
                <span id="schema-up-icon" class="mr-1 hidden"><i data-lucide="chevron-up" class="h-4 w-4 text-indigo-600"></i></span>
                <span id="schema-text">View Schema</span>
            </button>
        </div>
    </header>

    <!-- Configuration Popup -->
    <div id="config-popup" class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-gray-800">Database Configuration</h3>
            <button id="close-config-btn" class="text-gray-500 hover:text-gray-700">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <form id="config-form" class="space-y-3">
            <div>
                <label for="mysql-host" class="block text-sm font-medium text-gray-700">MySQL Host</label>
                <input type="text" id="mysql-host" name="mysql-host" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="localhost">
            </div>
            <div>
                <label for="mysql-user" class="block text-sm font-medium text-gray-700">MySQL User</label>
                <input type="text" id="mysql-user" name="mysql-user" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="root">
            </div>
            <div>
                <label for="mysql-password" class="block text-sm font-medium text-gray-700">MySQL Password</label>
                <input type="password" id="mysql-password" name="mysql-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="root">
            </div>
            <div>
                <label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                <input type="password" id="gemini-api-key" name="gemini-api-key" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="API Key">
            </div>
            <div class="pt-2">
                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save Configuration
                </button>
            </div>
        </form>
    </div>

    <div id="schema-display"
         class="bg-white border-gray-200 text-sm
                overflow-hidden transition-all duration-300 ease-in-out
                max-h-0 opacity-0 p-0 border-0">
        <h3 class="font-semibold mb-2 text-gray-700">Database Schema:</h3>
        <div id="schema-content" class="text-gray-600">
            Loading schema... 
            <div class="inline-block">
                <svg aria-hidden="true" class="w-4 h-4 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            </div>
        </div>
         <button id="refresh-schema-btn" class="mt-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded inline-flex items-center">
            <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg> Refresh
        </button>
    </div>

    <main class="flex-1 overflow-hidden p-4 flex flex-col">
        <div id="chat-history" class="flex-1 overflow-y-auto mb-4 space-y-4 p-4 bg-white rounded-lg shadow">
            <div class="p-3 rounded-lg bg-blue-100 text-blue-800 max-w-xl mr-auto">
                <p class="text-sm">Hello! Ask me something about the data (e.g., "Show me all employees in HR") or run a specific query using <code class="bg-blue-200 px-1 rounded">/run SELECT * FROM your_table LIMIT 10;</code>.</p>
            </div>
        </div>

        <div class="mt-auto p-4 bg-white rounded-lg shadow">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="Type your message or /run command..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg shadow transition duration-150 ease-in-out flex items-center justify-center">
                    <span id="send-text">Send</span>
                    <div id="send-spinner" class="hidden">
                        <svg aria-hidden="true" class="w-5 h-5 text-white animate-spin fill-white" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                            <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                        </svg>
                        <span class="sr-only">Loading...</span>
                    </div>
                </button>
            </form>
        </div>
    </main>

    <script>
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const sendSpinner = document.getElementById('send-spinner');
        const schemaDisplay = document.getElementById('schema-display');
        const schemaContent = document.getElementById('schema-content');
        const schemaToggleBtn = document.getElementById('schema-toggle-btn');
        const refreshSchemaBtn = document.getElementById('refresh-schema-btn');
        const configToggleBtn = document.getElementById('config-toggle-btn');
        const configPopup = document.getElementById('config-popup');
        const closeConfigBtn = document.getElementById('close-config-btn');
        const configForm = document.getElementById('config-form');

        // --- Helper Functions ---

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderMarkdown(text) {
            // Basic sanitization (consider a more robust library like DOMPurify if needed)
            const sanitizedHtml = marked.parse(text);
            return sanitizedHtml;
        }

        function addMessageToChat(sender, messageHtml, messageType = 'info') {
            const messageDiv = document.createElement('div');
            let bgColor, textColor, alignment;

            if (sender === 'user') {
                bgColor = 'bg-indigo-100';
                textColor = 'text-indigo-900';
                alignment = 'ml-auto'; // Align user messages to the right
            } else { // Assistant messages
                bgColor = 'bg-gray-100';
                textColor = 'text-gray-900';
                alignment = 'mr-auto'; // Align assistant messages to the left

                if (messageType === 'error') {
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                } else if (messageType === 'result') {
                     bgColor = 'bg-green-50'; // Lighter green for results
                     textColor = 'text-gray-900'; // Keep text dark for readability
                }
            }

            messageDiv.className = `p-3 rounded-lg ${bgColor} ${textColor} max-w-3xl ${alignment} prose prose-sm max-w-none`; // Use prose for markdown styling
            messageDiv.innerHTML = messageHtml; // Use innerHTML as we are injecting HTML
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }

        function createTableHtml(columns, results) {
            if (!results || results.length === 0) {
                return '<p class="text-sm text-gray-600 italic">Query returned no results.</p>';
            }
            if (!columns || columns.length === 0) {
                 return '<p class="text-sm text-red-600">Error: Missing column names for results.</p>';
            }

            let tableHtml = '<div class="results-table"><table><thead><tr>';
            columns.forEach(col => {
                tableHtml += `<th>${escapeHtml(col)}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            results.forEach(row => {
                tableHtml += '<tr>';
                // Ensure row is an array or tuple before iterating
                if (Array.isArray(row) || row instanceof Object && typeof row[Symbol.iterator] === 'function') {
                     // Check if columns length matches row length
                     if (row.length !== columns.length) {
                         console.warn("Row length mismatch:", row, "Columns:", columns);
                         // Add placeholder cells or handle error appropriately
                         tableHtml += `<td colspan="${columns.length}" class="text-red-500 italic">Data format error: row length mismatch</td>`;
                     } else {
                        row.forEach(cell => {
                            // Handle null or undefined values gracefully
                            const cellContent = cell === null || cell === undefined ? 'NULL' : cell;
                            tableHtml += `<td>${escapeHtml(String(cellContent))}</td>`; // Convert all cells to string before escaping
                        });
                     }
                } else {
                     // Handle cases where row might not be iterable or is a single value
                     console.warn("Unexpected row format:", row);
                     tableHtml += `<td colspan="${columns.length}" class="text-red-500 italic">Data format error: unexpected row type</td>`;
                }
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table></div>';
            return tableHtml;
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                messageInput.disabled = true;
                sendButton.disabled = true;
                sendText.classList.add('hidden');
                sendSpinner.classList.remove('hidden');
            } else {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendText.classList.remove('hidden');
                sendSpinner.classList.add('hidden');
                messageInput.focus(); // Refocus input after response
            }
        }

        // --- API Interaction ---

        // MODIFY fetchSchema to handle nested structure
        async function fetchSchema(showLoading = true) {
            if (showLoading) {
                 schemaContent.innerHTML = 'Loading schema... <div class="inline-block"><svg aria-hidden="true" class="w-4 h-4 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div>';
                 // No need for lucide.createIcons() since we're using SVG directly
            }
             try {
                 const response = await fetch('/schema');
                 if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { // Try to get more specific error from backend
                        const errData = await response.json();
                        // Adjust error path based on potential backend response structure
                        errorMsg = errData.detail || (errData.error && errData.error.schema && Array.isArray(errData.error.schema) ? errData.error.schema.join(', ') : errorMsg);
                    } catch(e) { /* ignore if body isn't json */ }
                    throw new Error(errorMsg);
                 }
                 const data = await response.json();
                 const schema = data.schema; // Expected format: { dbName: { tableName: [columns] } } or { error: { schema: ["message"] } }

                 // Check for the top-level error structure first
                 if (schema && typeof schema === 'object' && schema.error && schema.error.schema && Array.isArray(schema.error.schema)) {
                    schemaContent.innerHTML = `<p class="text-red-600">Error fetching schema: ${escapeHtml(schema.error.schema.join(', '))}</p>`;
                 } else if (schema && typeof schema === 'object' && Object.keys(schema).length > 0) {
                     let schemaHtml = '';
                     // Iterate through Databases
                     for (const dbName in schema) {
                         if (schema.hasOwnProperty(dbName)) {
                             schemaHtml += `<h4 class="font-semibold text-gray-800 mt-2 mb-1">Database: ${escapeHtml(dbName)}</h4>`;
                             const tables = schema[dbName]; // This could be { tableName: [cols] } or { error: ["msg"] }

                             // Check if the value for the dbName is an error object
                             if (typeof tables === 'object' && tables !== null && tables.error && Array.isArray(tables.error)) {
                                 schemaHtml += `<p class="text-sm text-red-500 pl-4 italic">Error fetching tables for this database: ${escapeHtml(tables.error.join(', '))}</p>`;
                             }
                             // Check if it's a valid tables object (and not the error object)
                             else if (typeof tables === 'object' && tables !== null && !tables.error) {
                                 if (Object.keys(tables).length > 0) {
                                     schemaHtml += '<ul class="list-disc list-inside space-y-1 pl-4">';
                                     // Iterate through Tables within the Database
                                     for (const tableName in tables) {
                                         if (tables.hasOwnProperty(tableName) && Array.isArray(tables[tableName])) {
                                             schemaHtml += `<li class="break-words"><strong class="font-medium">${escapeHtml(tableName)}</strong>: ${escapeHtml(tables[tableName].join(', '))}</li>`;
                                         }
                                     }
                                     schemaHtml += '</ul>';
                                 } else {
                                      schemaHtml += '<p class="text-sm text-gray-500 pl-4 italic">No tables found or accessible in this database.</p>';
                                 }
                             } else {
                                  // Handle unexpected format for the database entry
                                  schemaHtml += '<p class="text-sm text-gray-500 pl-4 italic">No table information available or unexpected format for this database.</p>';
                             }
                         }
                     }
                     schemaContent.innerHTML = schemaHtml || '<p class="text-gray-500">No databases or tables found.</p>'; // Fallback if loop resulted in empty string
                 } else {
                     // This case handles empty schema object {} or other non-error, non-object types
                     schemaContent.innerHTML = '<p class="text-gray-500">No databases or tables found, or unable to fetch schema.</p>';
                 }
             } catch (error) {
                 console.error('Error fetching schema:', error);
                 // Ensure error.message is escaped
                 schemaContent.innerHTML = `<p class="text-red-600">Failed to load schema. ${escapeHtml(error.message)}</p>`;
             }
        }

        async function sendMessage(message) {
            addMessageToChat('user', `<p>${escapeHtml(message)}</p>`); // Display user message immediately
            messageInput.value = ''; // Clear input
            setLoadingState(true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });

                if (!response.ok) {
                     // Try to get error details from response body
                     let errorDetail = `HTTP error! status: ${response.status}`;
                     try {
                         const errorData = await response.json();
                         errorDetail = errorData.detail || errorData.content || errorDetail;
                     } catch (e) { /* Ignore if body isn't JSON */ }
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                let assistantMessageHtml = '';

                if (data.type === 'result') {
                    assistantMessageHtml += `<p class="font-semibold">Generated SQL:</p><pre><code class="language-sql">${escapeHtml(data.query || '')}</code></pre>`;
                    assistantMessageHtml += createTableHtml(data.columns, data.results);
                    if (data.insights) {
                        // Render insights as Markdown
                        assistantMessageHtml += renderMarkdown(data.insights);
                    }
                } else if (data.type === 'info') {
                     // Render info potentially containing markdown (like code blocks)
                     assistantMessageHtml += renderMarkdown(data.content);
                } else if (data.type === 'error') {
                     // Render error potentially containing markdown (like code blocks)
                     assistantMessageHtml += renderMarkdown(data.content);
                } else {
                    assistantMessageHtml = `<p>${escapeHtml(String(data.content || 'Received unexpected response format.'))}</p>`;
                }

                addMessageToChat('assistant', assistantMessageHtml, data.type);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('assistant', `<p>Sorry, I encountered an error: ${escapeHtml(error.message)}</p>`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        // --- Configuration Popup Functions ---
        
        async function saveConfig(config) {
            try {
                // Send configuration to backend
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mysql_host: config.mysqlHost,
                        mysql_user: config.mysqlUser,
                        mysql_password: config.mysqlPassword,
                        gemini_api_key: config.geminiApiKey
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Save locally regardless of server response
                localStorage.setItem('sqlAssistantConfig', JSON.stringify(config));
                
                if (data.status === 'success') {
                    const connectionWarnings = [];
                    if (data.mysql_connection !== 'success') {
                        connectionWarnings.push(`MySQL connection warning: ${data.mysql_connection}`);
                    }
                    if (data.gemini_api !== 'success') {
                        connectionWarnings.push(`Gemini API warning: ${data.gemini_api}`);
                    }
                    
                    if (connectionWarnings.length > 0) {
                        alert(`Configuration saved with warnings:\n${connectionWarnings.join('\n')}\n\nChanges have been applied and .env file updated.`);
                    } else {
                        alert(`Configuration successfully saved and applied! No restart required.`);
                    }
                    
                    // Reload schema to reflect any database connection changes
                    fetchSchema(true);
                } else {
                    alert(`Configuration status: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                alert(`Error saving configuration: ${error.message}. Saved to local storage only.`);
                // Still save to localStorage as fallback
                localStorage.setItem('sqlAssistantConfig', JSON.stringify(config));
            }
        }
        
        function loadConfig() {
            const savedConfig = localStorage.getItem('sqlAssistantConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('mysql-host').value = config.mysqlHost || '';
                document.getElementById('mysql-user').value = config.mysqlUser || '';
                document.getElementById('mysql-password').value = config.mysqlPassword || '';
                document.getElementById('gemini-api-key').value = config.geminiApiKey || '';
            }
        }

        // --- Event Listeners ---

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        });

        schemaToggleBtn.addEventListener('click', () => {
            // Check if it's currently hidden (using max-height as indicator)
            const isHidden = schemaDisplay.classList.contains('max-h-0');
            const dbIcon = document.getElementById('schema-db-icon');
            const upIcon = document.getElementById('schema-up-icon');
            const schemaText = document.getElementById('schema-text');

            if (isHidden) {
                // --- Show Schema ---
                // Remove hidden state classes
                schemaDisplay.classList.remove('max-h-0', 'opacity-0', 'p-0', 'border-0', 'overflow-hidden');
                // Add shown state classes and overflow-y-auto
                schemaDisplay.classList.add('max-h-48', 'opacity-100', 'p-4', 'border-b', 'overflow-y-auto');

                // Update button icons
                dbIcon.classList.add('hidden');
                upIcon.classList.remove('hidden');
                schemaText.textContent = 'Hide Schema';

                // Fetch schema only if it hasn't been loaded or if forced refresh
                // Check if content is empty, contains 'Loading', or 'Failed'
                const needsFetching = !schemaContent.innerHTML.trim() ||
                                     schemaContent.innerHTML.includes('Loading') ||
                                     schemaContent.innerHTML.includes('Failed') ||
                                     schemaContent.innerHTML.includes('unable to fetch');
                if (needsFetching) {
                   fetchSchema();
                }
            } else {
                // --- Hide Schema ---
                // Remove shown state classes
                schemaDisplay.classList.remove('max-h-48', 'opacity-100', 'p-4', 'border-b', 'overflow-y-auto');
                // Add hidden state classes and overflow-hidden
                schemaDisplay.classList.add('max-h-0', 'opacity-0', 'p-0', 'border-0', 'overflow-hidden');

                // Update button icons
                dbIcon.classList.remove('hidden');
                upIcon.classList.add('hidden');
                schemaText.textContent = 'View Schema';
            }
        });

        refreshSchemaBtn.addEventListener('click', () => {
            fetchSchema(true); // Force refresh with loading indicator
        });
        
        // Configuration popup event handlers
        configToggleBtn.addEventListener('click', () => {
            const settingsIcon = document.getElementById('settings-icon');
            
            // Toggle config popup visibility
            if (configPopup.classList.contains('visible')) {
                // Start closing animation - rotate counter-clockwise
                configPopup.classList.remove('visible');
                
                // Reset any existing animation class first
                settingsIcon.classList.remove('settings-icon-rotate-cw');
                // Add counter-clockwise rotation
                settingsIcon.classList.add('settings-icon-rotate-ccw');
            } else {
                // Start opening animation - rotate clockwise
                configPopup.classList.add('visible');
                
                // Reset any existing animation class first
                settingsIcon.classList.remove('settings-icon-rotate-ccw');
                // Add clockwise rotation
                settingsIcon.classList.add('settings-icon-rotate-cw');
                
                loadConfig(); // Load saved config when opening
            }
        });
        
        closeConfigBtn.addEventListener('click', () => {
            configPopup.classList.remove('visible');
        });
        
        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const config = {
                mysqlHost: document.getElementById('mysql-host').value || "localhost",
                mysqlUser: document.getElementById('mysql-user').value || "root",
                mysqlPassword: document.getElementById('mysql-password').value || "root",
                geminiApiKey: document.getElementById('gemini-api-key').value || ""
            };
            await saveConfig(config);
            configPopup.classList.remove('visible');
        });

        // --- Initial Setup ---

        // Render initial icons
        lucide.createIcons();

        // Optionally fetch schema on load, but maybe better behind the button click
        // fetchSchema();
    </script>
</body>
</html>