<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataFlow</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Ensure code blocks wrap */
        pre {
            white-space: pre-wrap;       /* Since CSS 2.1 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
        /* Style for generated tables */
        .results-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            margin-top: 0.5rem; /* mt-2 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        .results-table th {
            background-color: #f8fafc; /* Tailwind slate-50 */
            position: sticky; /* Keep headers visible */
            top: 0;
            z-index: 10;
        }
        .results-table tbody tr:nth-child(even) {
            background-color: #f8fafc; /* Tailwind slate-50 */
        }
        .results-table tbody tr:hover {
            background-color: #f1f5f9; /* Tailwind slate-100 */
        }
        /* Config popup styles */
        #config-popup {
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 50;
            width: 300px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            /* Animation settings - more dramatic slide effect */
            opacity: 0;
            transform: translateY(-30px);
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none;
            display: block;
            visibility: hidden;
            /* Add a scale effect for more drama */
            transform-origin: top right;
            transform: translateY(-30px) scale(0.95);
        }
        #config-popup.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
            pointer-events: auto;
        }
        /* Add animation debug outlines if needed */
        #config-popup.debug-animation {
            outline: 2px solid red;
        }
        
        /* Settings icon rotation animation */
        @keyframes rotate-cw {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(180deg); }
        }
        
        @keyframes rotate-ccw {
            0% { transform: rotate(180deg); }
            100% { transform: rotate(0deg); }
        }
        
        .settings-icon-rotate-cw {
            animation: rotate-cw 0.5s ease forwards;
        }
        
        .settings-icon-rotate-ccw {
            animation: rotate-ccw 0.5s ease forwards;
        }

        /* Toast notification styles */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 24rem;
        }

        .toast {
            padding: 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            animation: toast-in 0.3s ease-in-out forwards;
            max-width: 100%;
        }

        .toast-success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .toast-warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .toast-error {
            background-color: #fee2e2;
            color: #b91c1c;
            border-left: 4px solid #ef4444;
        }

        .toast-info {
            background-color: #e0f2fe;
            color: #0c4a6e;
            border-left: 4px solid #0ea5e9;
        }

        .toast-content {
            flex: 1;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-line;
        }

        .toast-close {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
            padding: 0;
            color: currentColor;
            opacity: 0.7;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes toast-in {
            0% { 
                transform: translateX(100%);
                opacity: 0;
            }
            100% { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toast-out {
            0% { 
                transform: translateX(0);
                opacity: 1;
            }
            100% { 
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-remove {
            animation: toast-out 0.3s ease-in-out forwards;
        }

        /* Autocomplete popup for slash commands */
        #slash-command-popup {
            /* Positioned by JS relative to form container */
            /* min-width: 100px; */ /* Ensure it has some base width */
            left: 1rem; /* Match p-4 padding of parent container */
            /* width: calc(100% - 2rem); */ /* Adjust width considering parent padding */
            /* max-width: 300px; */ /* Optional: prevent it from becoming too wide */
            width: auto; /* Let it shrink to content */
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            overflow: hidden; /* Ensure inner hover respects rounded corners */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Mimic shadow of other popups/buttons */
        }
        #slash-command-popup div {
            /* padding: 0.5rem 0.75rem; */
            padding: 0.5rem 1rem; /* py-2 px-4 equivalent */
            cursor: pointer;
            text-align: center; /* Center the text like a button */
        }
        #slash-command-popup div:hover {
            background-color: #2563eb; /* Tailwind blue-600 for hover */
        }

        /* Style for the /run command tag in input */
        #run-command-tag {
            flex-shrink: 0; /* Prevent tag from shrinking */
            border-radius: 0.375rem; /* rounded-md */
            position: relative; /* For absolute positioning of the close button */
            overflow: hidden; /* To ensure hover effects confined */
            transition: background-color 0.2s ease-in-out;
            margin-left: 0.25rem; /* Added for spacing from left edge of wrapper */
            margin-right: 0.5rem; /* Added for spacing from the message input */
        }
        #run-command-tag::before { /* Overlay for hover effect */
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.2s ease-in-out, backdrop-filter 0.2s ease-in-out; /* Added backdrop-filter to transition */
            pointer-events: none; /* Allow clicks to pass through to button */
            backdrop-filter: blur(0); /* Initial state: no blur */
            border-radius: inherit; /* Inherit border-radius from parent for proper clipping */
        }
        #remove-run-tag-btn {
            /* display: none; */ /* Hidden by default - now controlled by opacity */
            opacity: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1; /* Ensure icon aligns well */
            transition: opacity 0.2s ease-in-out;
            z-index: 10; /* Ensure it's above the overlay */
            padding: 0.25rem; /* Add some padding to make it easier to click */
            border-radius: 9999px; /* Make it circular */
            background-color: rgba(0,0,0,0.3); /* Slight background for visibility */
        }
        #run-command-tag:hover::before {
            opacity: 1; /* Show overlay on hover */
            backdrop-filter: blur(2px); /* Apply blur on hover */
        }
        #run-command-tag:hover #remove-run-tag-btn {
            /* display: inline-flex; */ /* Show on hover of the tag */
            opacity: 1;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-md flex justify-between items-center">
        <a href="/" class="text-xl font-bold flex items-center">
            <i data-lucide="database" class="mr-2"></i> DataFlow
        </a>
        <div class="flex items-center space-x-3">
            <button id="config-toggle-btn" class="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg shadow text-sm transition duration-150 ease-in-out flex items-center">
                <i id="settings-icon" data-lucide="settings" class="mr-1 h-4 w-4 text-indigo-600"></i> Config
            </button>
            <button id="schema-toggle-btn" class="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg shadow text-sm transition duration-150 ease-in-out flex items-center">
                <span id="schema-db-icon" class="mr-1"><i data-lucide="database" class="h-4 w-4 text-indigo-600"></i></span>
                <span id="schema-up-icon" class="mr-1 hidden"><i data-lucide="chevron-up" class="h-4 w-4 text-indigo-600"></i></span>
                <span id="schema-text">View Schema</span>
            </button>
        </div>
    </header>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Configuration Popup -->
    <div id="config-popup" class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-gray-800">Database Configuration</h3>
            <button id="close-config-btn" class="text-gray-500 hover:text-gray-700">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <form id="config-form" class="space-y-3">
            <div>
                <label for="mysql-host" class="block text-sm font-medium text-gray-700">MySQL Host</label>
                <input type="text" id="mysql-host" name="mysql-host" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="localhost">
            </div>
            <div>
                <label for="mysql-user" class="block text-sm font-medium text-gray-700">MySQL User</label>
                <input type="text" id="mysql-user" name="mysql-user" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="root">
            </div>
            <div>
                <label for="mysql-password" class="block text-sm font-medium text-gray-700">MySQL Password</label>
                <input type="password" id="mysql-password" name="mysql-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="root">
            </div>
            <div>
                <label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                <input type="password" id="gemini-api-key" name="gemini-api-key" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="API Key">
            </div>
            <div class="pt-2">
                <button type="submit" id="config-save-btn" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <span id="config-save-text">Save Configuration</span>
                    <div id="config-save-spinner" class="hidden ml-2 flex items-center">
                        <!-- SVG Spinner will be inserted here by JS -->
                    </div>
                </button>
            </div>
        </form>
    </div>

    <div id="schema-display"
         class="bg-white border-gray-200 text-sm
                overflow-hidden transition-all duration-300 ease-in-out
                max-h-0 opacity-0 p-0 border-0">
        <h3 class="font-semibold mb-2 text-gray-700">Database Schema:</h3>
        <div id="schema-content" class="text-gray-600">
            <!-- Content will be dynamically inserted by JS, including spinner -->
        </div>
         <button id="refresh-schema-btn" class="mt-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded inline-flex items-center">
            <svg class="mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg> Refresh
        </button>
    </div>

    <main class="flex-1 overflow-hidden p-4 flex flex-col">
        <div id="chat-history" class="flex-1 overflow-y-auto mb-4 space-y-4 p-4 bg-white rounded-lg shadow">
            <div class="p-3 rounded-lg bg-blue-100 text-blue-800 max-w-xl mr-auto">
                <p class="text-sm">Hello! Ask me something about the data (e.g., "Show me all employees in HR") or run a specific query using <code class="bg-blue-200 px-1 rounded">/run SELECT * FROM your_table LIMIT 10;</code>.</p>
            </div>
        </div>

        <div class="mt-auto p-4 bg-white rounded-lg shadow relative">
            <div id="slash-command-popup" class="absolute bottom-full left-0 mb-1 w-auto bg-white border border-gray-300 rounded-md shadow-lg z-20 hidden">
                <!-- Suggestions will be added here by JS -->
            </div>
            <form id="chat-form" class="flex items-center space-x-3">
                <div id="input-wrapper" class="flex-1 flex items-center border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition duration-150 ease-in-out overflow-hidden">
                    <span id="run-command-tag" class="hidden bg-blue-600 text-white text-sm font-semibold py-1 px-3 flex items-center cursor-default">
                        /run
                        <button type="button" id="remove-run-tag-btn" class="text-blue-200 hover:text-white focus:outline-none p-1">
                            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </span>
                    <input type="text" id="message-input" placeholder="Type your message or /run command..." class="flex-1 px-4 py-2 focus:outline-none bg-transparent h-full text-sm" required>
                </div>
                <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg shadow transition duration-150 ease-in-out flex items-center justify-center h-10">
                    <span id="send-text">Send</span>
                    <div id="send-spinner" class="hidden">
                        <!-- SVG Spinner will be inserted here by JS -->
                    </div>
                </button>
            </form>
        </div>
    </main>

    <script>
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const sendSpinner = document.getElementById('send-spinner');
        const schemaDisplay = document.getElementById('schema-display');
        const schemaContent = document.getElementById('schema-content');
        const schemaToggleBtn = document.getElementById('schema-toggle-btn');
        const refreshSchemaBtn = document.getElementById('refresh-schema-btn');
        const configToggleBtn = document.getElementById('config-toggle-btn');
        const configPopup = document.getElementById('config-popup');
        const closeConfigBtn = document.getElementById('close-config-btn');
        const configForm = document.getElementById('config-form');

        // --- Autocomplete /run command elements ---
        const inputWrapper = document.getElementById('input-wrapper');
        const runCommandTag = document.getElementById('run-command-tag');
        const removeRunTagBtn = document.getElementById('remove-run-tag-btn');
        const slashCommandPopup = document.getElementById('slash-command-popup');
        let isRunCommandActive = false;
        const originalPlaceholder = "Type your message or /run command...";
        const runCommandPlaceholder = "Enter SQL query (e.g., SELECT * FROM users)";

        // --- Helper Functions ---

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderMarkdown(text) {
            // Basic sanitization (consider a more robust library like DOMPurify if needed)
            const sanitizedHtml = marked.parse(text);
            return sanitizedHtml;
        }

        // ADDED: Helper function to create spinner SVG
        function createSpinnerSvg(extraClasses = "w-5 h-5 text-white animate-spin fill-white") {
            return `
                <svg aria-hidden="true" class="${extraClasses}" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            `;
        }

        function addMessageToChat(sender, messageHtml, messageType = 'info') {
            const messageDiv = document.createElement('div');
            let bgColor, textColor, alignment;

            if (sender === 'user') {
                bgColor = 'bg-indigo-100';
                textColor = 'text-indigo-900';
                alignment = 'ml-auto'; // Align user messages to the right
            } else { // Assistant messages
                bgColor = 'bg-gray-100';
                textColor = 'text-gray-900';
                alignment = 'mr-auto'; // Align assistant messages to the left

                if (messageType === 'error') {
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                } else if (messageType === 'result') {
                     bgColor = 'bg-green-50'; // Lighter green for results
                     textColor = 'text-gray-900'; // Keep text dark for readability
                }
            }

            messageDiv.className = `p-3 rounded-lg ${bgColor} ${textColor} max-w-3xl ${alignment} prose prose-sm max-w-none`; // Use prose for markdown styling
            messageDiv.innerHTML = messageHtml; // Use innerHTML as we are injecting HTML
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }

        function createTableHtml(columns, results) {
            if (!results || results.length === 0) {
                return '<p class="text-sm text-gray-600 italic">Query returned no results.</p>';
            }
            if (!columns || columns.length === 0) {
                 return '<p class="text-sm text-red-600">Error: Missing column names for results.</p>';
            }

            let tableHtml = '<div class="results-table"><table><thead><tr>';
            columns.forEach(col => {
                tableHtml += `<th>${escapeHtml(col)}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            results.forEach(row => {
                tableHtml += '<tr>';
                // Ensure row is an array or tuple before iterating
                if (Array.isArray(row) || row instanceof Object && typeof row[Symbol.iterator] === 'function') {
                     // Check if columns length matches row length
                     if (row.length !== columns.length) {
                         console.warn("Row length mismatch:", row, "Columns:", columns);
                         // Add placeholder cells or handle error appropriately
                         tableHtml += `<td colspan="${columns.length}" class="text-red-500 italic">Data format error: row length mismatch</td>`;
                     } else {
                        row.forEach(cell => {
                            // Handle null or undefined values gracefully
                            const cellContent = cell === null || cell === undefined ? 'NULL' : cell;
                            tableHtml += `<td>${escapeHtml(String(cellContent))}</td>`; // Convert all cells to string before escaping
                        });
                     }
                } else {
                     // Handle cases where row might not be iterable or is a single value
                     console.warn("Unexpected row format:", row);
                     tableHtml += `<td colspan="${columns.length}" class="text-red-500 italic">Data format error: unexpected row type</td>`;
                }
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table></div>';
            return tableHtml;
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                messageInput.disabled = true;
                sendButton.disabled = true;
                sendText.classList.add('hidden');
                sendSpinner.classList.remove('hidden');
                sendSpinner.innerHTML = createSpinnerSvg(); // Use helper
            } else {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendText.classList.remove('hidden');
                sendSpinner.classList.add('hidden');
                messageInput.focus(); // Refocus input after response
            }
        }

        // --- API Interaction ---

        // MODIFY fetchSchema to handle nested structure
        async function fetchSchema(showLoading = true) {
            if (showLoading) {
                 schemaContent.innerHTML = 'Loading schema... ' + createSpinnerSvg("w-4 h-4 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600");
            }
             try {
                 const response = await fetch('/schema');
                 if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { // Try to get more specific error from backend
                        const errData = await response.json();
                        // Adjust error path based on potential backend response structure
                        errorMsg = errData.detail || (errData.error && errData.error.schema && Array.isArray(errData.error.schema) ? errData.error.schema.join(', ') : errorMsg);
                    } catch(e) { /* ignore if body isn't json */ }
                    throw new Error(errorMsg);
                 }
                 const data = await response.json();
                 const schema = data.schema; // Expected format: { dbName: { tableName: [columns] } } or { error: { schema: ["message"] } }

                 // Check for the top-level error structure first
                 if (schema && typeof schema === 'object' && schema.error && schema.error.schema && Array.isArray(schema.error.schema)) {
                    schemaContent.innerHTML = `<p class="text-red-600">Error fetching schema: ${escapeHtml(schema.error.schema.join(', '))}</p>`;
                 } else if (schema && typeof schema === 'object' && Object.keys(schema).length > 0) {
                     let schemaHtml = '';
                     // Iterate through Databases
                     for (const dbName in schema) {
                         if (schema.hasOwnProperty(dbName)) {
                             schemaHtml += `<h4 class="font-semibold text-gray-800 mt-2 mb-1">Database: ${escapeHtml(dbName)}</h4>`;
                             const tables = schema[dbName]; // This could be { tableName: [cols] } or { error: ["msg"] }

                             // Check if the value for the dbName is an error object
                             if (typeof tables === 'object' && tables !== null && tables.error && Array.isArray(tables.error)) {
                                 schemaHtml += `<p class="text-sm text-red-500 pl-4 italic">Error fetching tables for this database: ${escapeHtml(tables.error.join(', '))}</p>`;
                             }
                             // Check if it's a valid tables object (and not the error object)
                             else if (typeof tables === 'object' && tables !== null && !tables.error) {
                                 if (Object.keys(tables).length > 0) {
                                     schemaHtml += '<ul class="list-disc list-inside space-y-1 pl-4">';
                                     // Iterate through Tables within the Database
                                     for (const tableName in tables) {
                                         if (tables.hasOwnProperty(tableName) && Array.isArray(tables[tableName])) {
                                             schemaHtml += `<li class="break-words"><strong class="font-medium">${escapeHtml(tableName)}</strong>: ${escapeHtml(tables[tableName].join(', '))}</li>`;
                                         }
                                     }
                                     schemaHtml += '</ul>';
                                 } else {
                                      schemaHtml += '<p class="text-sm text-gray-500 pl-4 italic">No tables found or accessible in this database.</p>';
                                 }
                             } else {
                                  // Handle unexpected format for the database entry
                                  schemaHtml += '<p class="text-sm text-gray-500 pl-4 italic">No table information available or unexpected format for this database.</p>';
                             }
                         }
                     }
                     schemaContent.innerHTML = schemaHtml || '<p class="text-gray-500">No databases or tables found.</p>'; // Fallback if loop resulted in empty string
                 } else {
                     // This case handles empty schema object {} or other non-error, non-object types
                     schemaContent.innerHTML = '<p class="text-gray-500">No databases or tables found, or unable to fetch schema.</p>';
                 }
             } catch (error) {
                 console.error('Error fetching schema:', error);
                 // Ensure error.message is escaped
                 schemaContent.innerHTML = `<p class="text-red-600">Failed to load schema. ${escapeHtml(error.message)}</p>`;
             }
        }

        async function sendMessage(message) {
            addMessageToChat('user', `<p>${escapeHtml(message)}</p>`); // Display user message immediately
            messageInput.value = ''; // Clear input
            setLoadingState(true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });

                if (!response.ok) {
                     // Try to get error details from response body
                     let errorDetail = `HTTP error! status: ${response.status}`;
                     try {
                         const errorData = await response.json();
                         errorDetail = errorData.detail || errorData.content || errorDetail;
                     } catch (e) { /* Ignore if body isn't JSON */ }
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                let assistantMessageHtml = '';

                if (data.type === 'result') {
                    assistantMessageHtml += `<p class="font-semibold">Generated SQL:</p><pre><code class="language-sql">${escapeHtml(data.query || '')}</code></pre>`;
                    assistantMessageHtml += createTableHtml(data.columns, data.results);
                    if (data.insights) {
                        // Render insights as Markdown
                        assistantMessageHtml += renderMarkdown(data.insights);
                    }
                } else if (data.type === 'info') {
                     // Render info potentially containing markdown (like code blocks)
                     assistantMessageHtml += renderMarkdown(data.content);
                } else if (data.type === 'error') {
                     // Render error potentially containing markdown (like code blocks)
                     assistantMessageHtml += renderMarkdown(data.content);
                     if (data.ai_explanation) {
                        assistantMessageHtml += renderMarkdown(data.ai_explanation); // Render AI explanation as Markdown
                     }
                } else if (data.type === 'confirm_execution') {
                    // This case is now handled by addConfirmationMessageToChat
                    // It will set loading state to false to re-enable input while confirm buttons are visible.
                    addConfirmationMessageToChat(data.message, data.query);
                    return; // Return early as we don't want to call addMessageToChat or setLoadingState(false) again here
                } else {
                    assistantMessageHtml = `<p>${escapeHtml(String(data.content || 'Received unexpected response format.'))}</p>`;
                }

                addMessageToChat('assistant', assistantMessageHtml, data.type);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('assistant', `<p>Sorry, I encountered an error: ${escapeHtml(error.message)}</p>`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        // --- ADDED: Functions for handling query confirmation ---
        function addConfirmationMessageToChat(messageText, queryToConfirm) {
            const messageDiv = document.createElement('div');
            // Using a distinct style for confirmation prompts
            messageDiv.className = `p-3 rounded-lg bg-yellow-100 border border-yellow-300 text-yellow-800 max-w-3xl mr-auto prose prose-sm max-w-none shadow`;

            let htmlContent = `<p class="font-semibold">${escapeHtml(messageText)}</p>`;
            htmlContent += `<pre class="bg-yellow-50 p-2 rounded mt-2 border border-yellow-200"><code class="language-sql text-yellow-900">${escapeHtml(queryToConfirm)}</code></pre>`;
            htmlContent += `<div class="mt-3 flex space-x-2">
                                <button class="confirm-execute-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 px-4 rounded text-sm shadow-sm transition-colors duration-150" data-query="${escapeHtml(queryToConfirm)}">Execute</button>
                                <button class="cancel-execute-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-4 rounded text-sm shadow-sm transition-colors duration-150">Cancel</button>
                             </div>`;

            messageDiv.innerHTML = htmlContent;
            chatHistory.appendChild(messageDiv);

            // Add event listeners to the new buttons
            messageDiv.querySelector('.confirm-execute-btn').addEventListener('click', async function() {
                const query = this.dataset.query;
                // Update the current message to "Executing..."
                const parentMessageBubble = this.closest('.p-3.rounded-lg');
                if (parentMessageBubble) {
                    parentMessageBubble.innerHTML = `<p class="font-semibold text-blue-700">Executing query:</p><pre class="bg-blue-50 p-2 rounded mt-2 border border-blue-200"><code class="language-sql text-blue-900">${escapeHtml(query)}</code></pre><p class="mt-2 text-sm text-gray-600 italic">Please wait...</p>`;
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
                await executeConfirmedQuery(query); // This will add a *new* message with the result
                // ADDED: Update the original confirmation bubble after execution
                if (parentMessageBubble) {
                    parentMessageBubble.innerHTML = `<p class="text-sm text-gray-600 italic">The confirmed query execution has been processed. See result in the new message below.</p>`;
                    // Optionally, change its styling to be less prominent or more indicative of a completed action
                    parentMessageBubble.className = `p-3 rounded-lg bg-gray-50 border border-gray-200 text-gray-500 max-w-3xl mr-auto prose prose-sm max-w-none shadow-sm`;
                }
            });

            messageDiv.querySelector('.cancel-execute-btn').addEventListener('click', function() {
                // Replace current message with cancellation
                const parentMessageBubble = this.closest('.p-3.rounded-lg');
                if (parentMessageBubble) {
                     parentMessageBubble.className = `p-3 rounded-lg bg-gray-100 text-gray-600 max-w-3xl mr-auto prose prose-sm max-w-none italic shadow`;
                    parentMessageBubble.innerHTML = `<p>Execution cancelled by user.</p>`;
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });

            chatHistory.scrollTop = chatHistory.scrollHeight;
            setLoadingState(false); // Ensure main input is usable while confirmation is shown
        }

        async function executeConfirmedQuery(query) {
            // setLoadingState(true); // Main input is already re-enabled by addConfirmationMessageToChat, keep it that way.
                                 // We want the user to be able to type a new query if they wish, while the confirmed one executes.
                                 // However, we should show a specific loading indicator for this execution if possible, or rely on the message update.
            // For now, the message update to "Executing..." will serve as the primary indicator.

            try {
                const response = await fetch('/execute_confirmed_sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                });

                if (!response.ok) {
                    let errorDetail = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.content || errorData.detail || errorDetail;
                    } catch (e) { /* Ignore if body isn't JSON */ }
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                let resultMessageHtml = '';

                // Process response from /execute_confirmed_sql (similar to /chat)
                // The 'assistant' will now deliver the outcome of the confirmed query.
                if (data.type === 'info') {
                    resultMessageHtml = renderMarkdown(data.content);
                } else if (data.type === 'error') {
                    resultMessageHtml = renderMarkdown(data.content); // Error messages can also contain markdown (like code blocks)
                    if (data.ai_explanation) {
                        resultMessageHtml += renderMarkdown(data.ai_explanation); // Render AI explanation as Markdown
                    }
                } else if (data.type === 'result') { // Should be rare for this flow but handle
                    resultMessageHtml += `<p class="font-semibold">Query Executed:</p><pre><code class="language-sql">${escapeHtml(data.query || '')}</code></pre>`;
                    resultMessageHtml += createTableHtml(data.columns, data.results);
                    if (data.insights) {
                        resultMessageHtml += renderMarkdown(data.insights);
                    }
                } else {
                    resultMessageHtml = `<p>${escapeHtml(String(data.content || 'Received unexpected response format.'))}</p>`;
                }
                // Add this result as a new message from the assistant
                addMessageToChat('assistant', resultMessageHtml, data.type);

            } catch (error) {
                console.error('Error executing confirmed query:', error);
                addMessageToChat('assistant', `<p>Sorry, I encountered an error during the confirmed execution: ${escapeHtml(error.message)}</p>`, 'error');
            } finally {
                // setLoadingState(false); // No need to call setLoadingState(false) here as it wasn't set to true at the start of this func.
            }
        }
        // --- END: Functions for handling query confirmation ---

        // --- ADDED: Toast Notification Function ---
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('Toast container not found!');
                return;
            }

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`; // e.g., toast toast-success

            const content = document.createElement('div');
            content.className = 'toast-content';
            content.textContent = message;

            const closeButton = document.createElement('button');
            closeButton.className = 'toast-close';
            closeButton.innerHTML = '&times;'; // Simple 'x'
            closeButton.onclick = () => {
                toast.classList.add('toast-remove');
                toast.addEventListener('animationend', () => {
                    if (container.contains(toast)) { // Check if still a child before removing
                        container.removeChild(toast);
                    }
                });
            };

            toast.appendChild(content);
            toast.appendChild(closeButton);
            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                // Check if toast is still in DOM (user might have closed it manually)
                if (container.contains(toast) && !toast.classList.contains('toast-remove')) {
                    toast.classList.add('toast-remove');
                    toast.addEventListener('animationend', () => {
                         if (container.contains(toast)) { // Double check before removing
                            container.removeChild(toast);
                         }
                    });
                }
            }, duration);
        }
        // --- END: Toast Notification Function ---

        // --- Configuration Popup Functions ---
        
        async function saveConfig(config) {
            // Set loading state
            const saveBtn = document.getElementById('config-save-btn');
            const saveText = document.getElementById('config-save-text'); 
            const saveSpinner = document.getElementById('config-save-spinner');
            
            saveBtn.disabled = true;
            saveText.classList.add('opacity-75');
            saveSpinner.classList.remove('hidden');
            saveSpinner.innerHTML = createSpinnerSvg("w-4 h-4 text-white animate-spin fill-indigo-300"); // Use helper with specific classes
            
            try {
                // Send configuration to backend
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mysql_host: config.mysqlHost,
                        mysql_user: config.mysqlUser,
                        mysql_password: config.mysqlPassword,
                        gemini_api_key: config.geminiApiKey
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Save locally regardless of server response
                localStorage.setItem('sqlAssistantConfig', JSON.stringify(config));
                
                if (data.status === 'success') {
                    const connectionWarnings = [];
                    if (data.mysql_connection !== 'success') {
                        connectionWarnings.push(`MySQL connection warning: ${data.mysql_connection}`);
                    }
                    if (data.gemini_api !== 'success') {
                        connectionWarnings.push(`Gemini API warning: ${data.gemini_api}`);
                    }
                    
                    if (connectionWarnings.length > 0) {
                        showToast(`Configuration saved with warnings:\n${connectionWarnings.join('\n')}\n\nChanges have been applied and .env file updated.`, 'warning');
                    } else {
                        showToast('Configuration successfully saved and applied! No restart required.', 'success');
                    }
                    
                    // Reload schema to reflect any database connection changes
                    fetchSchema(true);
                } else {
                    showToast(`Configuration status: ${data.message}`, 'info');
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                showToast(`Error saving configuration: ${error.message}. Saved to local storage only.`, 'error');
                // Still save to localStorage as fallback
                localStorage.setItem('sqlAssistantConfig', JSON.stringify(config));
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveText.classList.remove('opacity-75');
                saveSpinner.classList.add('hidden');
                saveSpinner.innerHTML = ""; // Clear spinner
            }
        }
        
        function loadConfig() {
            const savedConfig = localStorage.getItem('sqlAssistantConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('mysql-host').value = config.mysqlHost || '';
                document.getElementById('mysql-user').value = config.mysqlUser || '';
                document.getElementById('mysql-password').value = config.mysqlPassword || '';
                document.getElementById('gemini-api-key').value = config.geminiApiKey || '';
            }
        }

        // --- Autocomplete and /run Tag Functions ---
        function showRunCommandTag() {
            runCommandTag.classList.remove('hidden');
            messageInput.placeholder = runCommandPlaceholder;
            isRunCommandActive = true;
            messageInput.value = '';
            hideSlashCommandPopup();
            messageInput.focus();
        }

        function hideRunCommandTag() {
            runCommandTag.classList.add('hidden');
            messageInput.placeholder = originalPlaceholder;
            isRunCommandActive = false;
            messageInput.value = '';
            messageInput.focus();
        }

        function showSlashCommandPopup() {
            const inputValue = messageInput.value;
            // console.log("[Debug] inputValue:", inputValue);

            const startsWithSlash = inputValue.startsWith('/');
            // console.log("[Debug] startsWithSlash:", startsWithSlash);

            const isLengthOne = inputValue.length === 1;
            // console.log("[Debug] isLengthOne (inputValue.length === 1):", isLengthOne);

            let subStringLower = "";
            if (inputValue.length > 1) {
                subStringLower = inputValue.substring(1).toLowerCase();
            }
            // console.log("[Debug] subStringLower (inputValue.substring(1).toLowerCase()):", subStringLower);

            const runStartsWithSub = "run".startsWith(subStringLower); // Corrected: removed leading slash from "run"
            // console.log("[Debug] \"run\".startsWith(subStringLower):", runStartsWithSub);

            const shouldShowPopup = startsWithSlash && (isLengthOne || (inputValue.length > 1 && runStartsWithSub));
            // console.log("[Debug] Overall condition (startsWithSlash && (isLengthOne || (inputValue.length > 1 && runStartsWithSub))):", shouldShowPopup);

            if (shouldShowPopup) {
                slashCommandPopup.innerHTML = ''; // Clear previous suggestions
                const suggestionDiv = document.createElement('div');
                suggestionDiv.textContent = '/run';
                suggestionDiv.dataset.command = '/run';
                suggestionDiv.addEventListener('click', () => {
                    showRunCommandTag();
                });
                slashCommandPopup.appendChild(suggestionDiv);
                slashCommandPopup.classList.remove('hidden');
            } else {
                hideSlashCommandPopup();
            }
        }

        function hideSlashCommandPopup() {
            slashCommandPopup.classList.add('hidden');
            slashCommandPopup.innerHTML = '';
        }

        // --- Event Listeners ---

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const queryPart = messageInput.value.trim();
            let messageToSend;

            if (isRunCommandActive) {
                if (queryPart) {
                    messageToSend = "/run " + queryPart;
                } else {
                    showToast("Please enter an SQL query to run.", "warning", 3000);
                    messageInput.focus();
                    return;
                }
            } else {
                messageToSend = queryPart;
            }

            if (messageToSend) {
                sendMessage(messageToSend);
                if (isRunCommandActive) {
                    hideRunCommandTag();
                }
            }
        });

        schemaToggleBtn.addEventListener('click', () => {
            const isHidden = schemaDisplay.classList.contains('max-h-0');
            const dbIcon = document.getElementById('schema-db-icon');
            const upIcon = document.getElementById('schema-up-icon');
            const schemaText = document.getElementById('schema-text');

            if (isHidden) {
                schemaDisplay.classList.remove('max-h-0', 'opacity-0', 'p-0', 'border-0', 'overflow-hidden');
                schemaDisplay.classList.add('max-h-48', 'opacity-100', 'p-4', 'border-b', 'overflow-y-auto');

                dbIcon.classList.add('hidden');
                upIcon.classList.remove('hidden');
                schemaText.textContent = 'Hide Schema';

                const currentHTML = schemaContent.innerHTML;
                const trimmedContent = currentHTML.trim();

                const isEmptyOrPlaceholder = trimmedContent.startsWith("<!--") || trimmedContent === "";
                const isLoading = currentHTML.includes('Loading schema...');
                const hasFailedOrIsEmptyBackend = currentHTML.includes('Failed to load schema') ||
                                  currentHTML.includes('Error fetching schema') ||
                                  currentHTML.includes('No databases or tables found, or unable to fetch schema') ||
                                  currentHTML.includes('No databases or tables found.');

                const needsFetching = isEmptyOrPlaceholder || isLoading || hasFailedOrIsEmptyBackend;
                if (needsFetching) {
                   fetchSchema();
                }
            } else {
                schemaDisplay.classList.remove('max-h-48', 'opacity-100', 'p-4', 'border-b', 'overflow-y-auto');
                schemaDisplay.classList.add('max-h-0', 'opacity-0', 'p-0', 'border-0', 'overflow-hidden');

                dbIcon.classList.remove('hidden');
                upIcon.classList.add('hidden');
                schemaText.textContent = 'View Schema';
            }
        });

        refreshSchemaBtn.addEventListener('click', () => {
            fetchSchema(true);
        });
        
        configToggleBtn.addEventListener('click', () => {
            const settingsIcon = document.getElementById('settings-icon');
            
            if (configPopup.classList.contains('visible')) {
                configPopup.classList.remove('visible');
                
                settingsIcon.classList.remove('settings-icon-rotate-cw');
                settingsIcon.classList.add('settings-icon-rotate-ccw');
            } else {
                configPopup.classList.add('visible');
                
                settingsIcon.classList.remove('settings-icon-rotate-ccw');
                settingsIcon.classList.add('settings-icon-rotate-cw');
                
                loadConfig();
            }
        });
        
        closeConfigBtn.addEventListener('click', () => {
            configPopup.classList.remove('visible');
        });
        
        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const config = {
                mysqlHost: document.getElementById('mysql-host').value || "localhost",
                mysqlUser: document.getElementById('mysql-user').value || "root",
                mysqlPassword: document.getElementById('mysql-password').value || "root",
                geminiApiKey: document.getElementById('gemini-api-key').value || ""
            };
            await saveConfig(config);
            configPopup.classList.remove('visible');
        });

        messageInput.addEventListener('input', () => {
            const inputValue = messageInput.value;
            if (isRunCommandActive) {
                hideSlashCommandPopup();
                return;
            }

            if (inputValue.startsWith('/')) {
                showSlashCommandPopup();
                if (inputValue === "/run ") {
                    showRunCommandTag();
                }
            } else {
                hideSlashCommandPopup();
            }
        });

        removeRunTagBtn.addEventListener('click', () => {
            hideRunCommandTag();
        });
        
        document.addEventListener('click', function(event) {
            if (!slashCommandPopup.classList.contains('hidden')) {
                const isClickInsidePopup = slashCommandPopup.contains(event.target);
                const isClickOnInput = messageInput.contains(event.target);
                if (!isClickInsidePopup && !isClickOnInput) {
                    hideSlashCommandPopup();
                }
            }
        });

        // --- Initial Setup ---

        lucide.createIcons();
    </script>
</body>
</html>